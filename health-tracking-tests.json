{
  "info": {
    "name": "Health Tracking Tests - Week 6 - COMPLETE",
    "description": "Complete health tracking test suite with enhanced authentication",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "variable": [
    {
      "key": "baseUrl",
      "value": "http://localhost:3000",
      "type": "string"
    },
    {
      "key": "authToken",
      "value": "s%3Abb695hmmE8o8QCYCT1z6dNBHMkuDzy7z.g2B%2FVLHr0qcL5SptEO6ivdFItDA4%2FWMcM8j%2F3byQtm0",
      
      
      "type": "string"
    },
    {
      "key": "petId",
      "value": "929",
      "type": "string"
    },
    {
      "key": "testEmail",
      "value": "aliabdulsameea69@gmail.com",
      "type": "string"
    },
    {
      "key": "testPassword",
      "value": "HawlerErbil6824!",
      "type": "string"
    }
  ],
  "item": [
    {
      "name": "0. Login and Get Session",
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/x-www-form-urlencoded"
          }
        ],
        "body": {
          "mode": "urlencoded",
          "urlencoded": [
            {
              "key": "email",
              "value": "{{testEmail}}",
              "type": "text"
            },
            {
              "key": "password",
              "value": "{{testPassword}}",
              "type": "text"
            }
          ]
        },
        "url": {
          "raw": "{{baseUrl}}/auth/login",
          "protocol": "http",
          "host": ["localhost"],
          "port": "3000",
          "path": ["auth", "login"]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "// Enhanced login test script with debugging",
              "console.log('=== LOGIN TEST DEBUG ===');",
              "console.log('Response status:', pm.response.code);",
              "console.log('Response headers:', JSON.stringify(pm.response.headers, null, 2));",
              "",
              "// Check if login was successful",
              "if (pm.response.code === 302) {",
              "    pm.test('Login successful - redirect detected', function () {",
              "        pm.expect(pm.response.code).to.equal(302);",
              "    });",
              "    ",
              "    // Extract session cookie from multiple sources",
              "    var cookie = pm.cookies.get('connect.sid');",
              "    if (cookie) {",
              "        pm.collectionVariables.set('authToken', cookie.value);",
              "        console.log('✅ Auth token set from cookies:', cookie.value.substring(0, 50) + '...');",
              "    } else {",
              "        // Try to extract from Set-Cookie header",
              "        var setCookieHeader = pm.response.headers.get('Set-Cookie');",
              "        if (setCookieHeader && setCookieHeader.includes('connect.sid')) {",
              "            var match = setCookieHeader.match(/connect\\.sid=([^;]+)/);",
              "            if (match && match[1]) {",
              "                pm.collectionVariables.set('authToken', match[1]);",
              "                console.log('✅ Auth token set from header:', match[1].substring(0, 50) + '...');",
              "            }",
              "        } else {",
              "            console.log('❌ No session cookie found in response');",
              "        }",
              "    }",
              "    ",
              "    console.log('Redirect location:', pm.response.headers.get('Location'));",
              "    console.log('Current authToken variable:', pm.collectionVariables.get('authToken') ? 'SET' : 'NOT SET');",
              "} else if (pm.response.code === 400) {",
              "    console.log('❌ Login failed - invalid credentials');",
              "    console.log('Response body:', pm.response.text());",
              "    pm.test('Login should not fail', function () {",
              "        pm.expect(pm.response.code).to.not.equal(400);",
              "    });",
              "} else {",
              "    console.log('Unexpected response code:', pm.response.code);",
              "    console.log('Response body preview:', pm.response.text().substring(0, 200));",
              "}"
            ]
          }
        }
      ]
    },
    {
      "name": "1. Get Health Records (Check Current Data)",
      "request": {
        "method": "GET",
        "header": [
          {
            "key": "Cookie",
            "value": "connect.sid={{authToken}}"
          }
        ],
        "url": {
          "raw": "{{baseUrl}}/health/records",
          "protocol": "http",
          "host": ["localhost"],
          "port": "3000",
          "path": ["health", "records"]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "console.log('=== HEALTH RECORDS TEST ===');",
              "console.log('Response status:', pm.response.code);",
              "console.log('Content-Type:', pm.response.headers.get('Content-Type'));",
              "console.log('Using authToken:', pm.collectionVariables.get('authToken') ? 'PRESENT' : 'MISSING');",
              "",
              "// Handle authentication and data retrieval",
              "if (pm.response.code === 302) {",
              "    pm.test('Authentication failed - redirect to login', function () {",
              "        pm.expect(pm.response.headers.get('Location')).to.include('login');",
              "    });",
              "    console.log('❌ Authentication failed - run Login test first');",
              "    console.log('Current authToken:', pm.collectionVariables.get('authToken'));",
              "} else if (pm.response.code === 200) {",
              "    pm.test('Successfully retrieved health records', function () {",
              "        pm.response.to.have.status(200);",
              "    });",
              "    ",
              "    pm.test('Returns JSON data', function () {",
              "        pm.response.to.be.json;",
              "    });",
              "    ",
              "    var jsonData = pm.response.json();",
              "    console.log('Health records structure:', Object.keys(jsonData));",
              "    ",
              "    // Update petId if different from current",
              "    var petIds = Object.keys(jsonData);",
              "    if (petIds.length > 0) {",
              "        var currentPetId = pm.collectionVariables.get('petId');",
              "        if (!petIds.includes(currentPetId)) {",
              "            pm.collectionVariables.set('petId', petIds[0]);",
              "            console.log('⚠️ Updated petId to:', petIds[0]);",
              "        }",
              "        console.log('Available pets:', petIds);",
              "    } else {",
              "        console.log('⚠️ No health records found for any pets');",
              "    }",
              "    ",
              "    console.log('Sample records:', JSON.stringify(jsonData, null, 2));",
              "} else {",
              "    console.log('Unexpected response:', pm.response.code);",
              "    console.log('Response preview:', pm.response.text().substring(0, 200));",
              "}"
            ]
          }
        }
      ]
    },
    {
      "name": "2. Add Health Record - Valid Data",
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/x-www-form-urlencoded"
          },
          {
            "key": "Cookie",
            "value": "connect.sid={{authToken}}"
          }
        ],
        "body": {
          "mode": "urlencoded",
          "urlencoded": [
            {
              "key": "pet_id",
              "value": "{{petId}}",
              "type": "text"
            },
            {
              "key": "weight",
              "value": "28.5",
              "type": "text"
            },
            {
              "key": "diet",
              "value": "Premium Kibble + Chicken",
              "type": "text"
            },
            {
              "key": "medical_notes",
              "value": "Regular checkup - healthy and active",
              "type": "text"
            },
            {
              "key": "date_recorded",
              "value": "2024-01-10",
              "type": "text"
            }
          ]
        },
        "url": {
          "raw": "{{baseUrl}}/health",
          "protocol": "http",
          "host": ["localhost"],
          "port": "3000",
          "path": ["health"]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "console.log('=== ADD HEALTH RECORD TEST ===');",
              "console.log('Response status:', pm.response.code);",
              "console.log('Using petId:', pm.collectionVariables.get('petId'));",
              "",
              "// Handle various response scenarios",
              "pm.test('No server errors', function () {",
              "    pm.expect(pm.response.text()).to.not.include('Internal Server Error');",
              "});",
              "",
              "if (pm.response.code === 302) {",
              "    pm.test('Redirects on success', function () {",
              "        var location = pm.response.headers.get('Location');",
              "        pm.expect(location).to.include('health-tracker-history');",
              "    });",
              "    console.log('✅ Record added successfully - redirect to history');",
              "} else if (pm.response.code === 200) {",
              "    pm.test('Success response for valid data', function () {",
              "        pm.response.to.have.status(200);",
              "    });",
              "    console.log('✅ Record added successfully - 200 response');",
              "} else if (pm.response.code === 400) {",
              "    console.log('❌ Validation error - response:', pm.response.text());",
              "    pm.test('Should not get validation error for valid data', function () {",
              "        pm.expect(pm.response.code).to.not.equal(400);",
              "    });",
              "} else if (pm.response.code === 500) {",
              "    console.log('❌ Server error:', pm.response.text());",
              "} else {",
              "    console.log('Unexpected response:', pm.response.code);",
              "    console.log('Response:', pm.response.text());",
              "}"
            ]
          }
        }
      ]
    },
    {
      "name": "3. Edge Case - Negative Weight",
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/x-www-form-urlencoded"
          },
          {
            "key": "Cookie",
            "value": "connect.sid={{authToken}}"
          }
        ],
        "body": {
          "mode": "urlencoded",
          "urlencoded": [
            {
              "key": "pet_id",
              "value": "{{petId}}",
              "type": "text"
            },
            {
              "key": "weight",
              "value": "-5",
              "type": "text"
            },
            {
              "key": "diet",
              "value": "Test Diet for negative weight",
              "type": "text"
            },
            {
              "key": "date_recorded",
              "value": "2024-01-10",
              "type": "text"
            }
          ]
        },
        "url": {
          "raw": "{{baseUrl}}/health",
          "protocol": "http",
          "host": ["localhost"],
          "port": "3000",
          "path": ["health"]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "console.log('=== NEGATIVE WEIGHT TEST ===');",
              "console.log('Response status:', pm.response.code);",
              "",
              "// Edge Case Test: Should reject negative weight",
              "if (pm.response.code === 400) {",
              "    pm.test('Rejects negative weight - status 400', function () {",
              "        pm.response.to.have.status(400);",
              "    });",
              "    ",
              "    pm.test('Shows validation error message', function () {",
              "        var responseText = pm.response.text();",
              "        pm.expect(responseText).to.include('Weight must be between');",
              "    });",
              "    console.log('✅ Correctly rejected negative weight');",
              "} else if (pm.response.code === 302) {",
              "    console.log('❌ Negative weight was accepted (should be rejected)');",
              "    pm.test('Negative weight should be rejected', function () {",
              "        pm.expect(pm.response.code).to.not.equal(302);",
              "    });",
              "} else {",
              "    console.log('Unexpected response for negative weight:', pm.response.code);",
              "    console.log('Response:', pm.response.text());",
              "}"
            ]
          }
        }
      ]
    },
    {
      "name": "4. Edge Case - Future Date",
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/x-www-form-urlencoded"
          },
          {
            "key": "Cookie",
            "value": "connect.sid={{authToken}}"
          }
        ],
        "body": {
          "mode": "urlencoded",
          "urlencoded": [
            {
              "key": "pet_id",
              "value": "{{petId}}",
              "type": "text"
            },
            {
              "key": "weight",
              "value": "20.0",
              "type": "text"
            },
            {
              "key": "date_recorded",
              "value": "2025-12-31",
              "type": "text"
            }
          ]
        },
        "url": {
          "raw": "{{baseUrl}}/health",
          "protocol": "http",
          "host": ["localhost"],
          "port": "3000",
          "path": ["health"]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "console.log('=== FUTURE DATE TEST ===');",
              "console.log('Response status:', pm.response.code);",
              "",
              "// Edge Case Test: Should reject future dates",
              "if (pm.response.code === 400) {",
              "    pm.test('Rejects future dates - status 400', function () {",
              "        pm.response.to.have.status(400);",
              "    });",
              "    ",
              "    pm.test('Shows date validation error', function () {",
              "        pm.expect(pm.response.text()).to.include('cannot be in the future');",
              "    });",
              "    console.log('✅ Correctly rejected future date');",
              "} else if (pm.response.code === 302) {",
              "    console.log('❌ Future date was accepted (should be rejected)');",
              "    pm.test('Future date should be rejected', function () {",
              "        pm.expect(pm.response.code).to.not.equal(302);",
              "    });",
              "} else {",
              "    console.log('Unexpected response for future date:', pm.response.code);",
              "    console.log('Response:', pm.response.text());",
              "}"
            ]
          }
        }
      ]
    },
    {
      "name": "5. Verify Record Was Created",
      "request": {
        "method": "GET",
        "header": [
          {
            "key": "Cookie",
            "value": "connect.sid={{authToken}}"
          }
        ],
        "url": {
          "raw": "{{baseUrl}}/health/records",
          "protocol": "http",
          "host": ["localhost"],
          "port": "3000",
          "path": ["health", "records"]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "console.log('=== VERIFICATION TEST ===');",
              "console.log('Response status:', pm.response.code);",
              "",
              "// Database Test: Verify our test record exists",
              "if (pm.response.code === 200) {",
              "    pm.test('Successfully retrieved records', function () {",
              "        pm.response.to.have.status(200);",
              "    });",
              "    ",
              "    var jsonData = pm.response.json();",
              "    var currentPetId = pm.collectionVariables.get('petId');",
              "    ",
              "    pm.test('Health records exist', function () {",
              "        pm.expect(Object.keys(jsonData).length).to.be.greaterThan(0);",
              "    });",
              "    ",
              "    // Check if our test data is in the records",
              "    var petRecords = jsonData[currentPetId];",
              "    if (petRecords && petRecords.length > 0) {",
              "        console.log('✅ Found', petRecords.length, 'records for pet', currentPetId);",
              "        ",
              "        // Look for our test record with weight 28.5",
              "        var testRecord = petRecords.find(record => record.weight == 28.5);",
              "        if (testRecord) {",
              "            console.log('✅ Test record found with weight 28.5');",
              "        }",
              "        ",
              "        pm.test('Test record has weight data', function () {",
              "            var hasWeight = petRecords.some(record => record.weight !== null);",
              "            pm.expect(hasWeight).to.be.true;",
              "        });",
              "    } else {",
              "        console.log('⚠️ No records found for pet', currentPetId);",
              "    }",
              "    ",
              "    console.log('Final records structure:', Object.keys(jsonData));",
              "} else {",
              "    console.log('❌ Cannot verify records - response:', pm.response.code);",
              "    console.log('Response:', pm.response.text());",
              "}"
            ]
          }
        }
      ]
    },
    {
      "name": "6. Test Chart.js Data Structure",
      "request": {
        "method": "GET",
        "header": [
          {
            "key": "Cookie",
            "value": "connect.sid={{authToken}}"
          }
        ],
        "url": {
          "raw": "{{baseUrl}}/health/records",
          "protocol": "http",
          "host": ["localhost"],
          "port": "3000",
          "path": ["health", "records"]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "console.log('=== CHART.JS DATA TEST ===');",
              "",
              "// Chart.js Data Test: Verify data structure is suitable for charts",
              "pm.test('Data structure works for Chart.js', function () {",
              "    var jsonData = pm.response.json();",
              "    ",
              "    // Check if we have the expected structure",
              "    pm.expect(jsonData).to.be.an('object');",
              "    ",
              "    // Check if we have pet records",
              "    var petIds = Object.keys(jsonData);",
              "    pm.expect(petIds.length).to.be.greaterThan(0);",
              "    ",
              "    // Check if records have date and weight for charts",
              "    var firstPetId = petIds[0];",
              "    var records = jsonData[firstPetId];",
              "    pm.expect(records).to.be.an('array');",
              "    ",
              "    var chartDataInfo = {",
              "        pets: petIds.length,",
              "        records: records.length,",
              "        hasDates: records.some(r => r.date_recorded),",
              "        hasWeights: records.some(r => r.weight),",
              "        sampleRecord: records.length > 0 ? records[0] : null",
              "    };",
              "    ",
              "    console.log('Data structure for charts:', chartDataInfo);",
              "    ",
              "    // Additional validation for chart compatibility",
              "    pm.expect(chartDataInfo.hasDates).to.be.true;",
              "    pm.expect(chartDataInfo.hasWeights).to.be.true;",
              "});"
            ]
          }
        }
      ]
    }
  ]
}