<%- include('../partials/admin-header', {title: 'Pending Bio Approvals'}) %>

<div class="container-fluid">
  <div class="row">
    <!-- Sidebar -->
    <nav class="col-md-3 col-lg-2 d-md-block bg-light sidebar">
      <div class="position-sticky pt-3">
        <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted">
          <span>Admin Panel</span>
        </h6>
        <ul class="nav flex-column">
          <li class="nav-item">
            <a class="nav-link" href="/admin/dashboard">
              <i class="bi bi-speedometer2 me-2"></i>
              Dashboard
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/admin/users">
              <i class="bi bi-people me-2"></i>
              User Management
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link active" href="/admin/pending-bios">
              <i class="bi bi-file-text me-2"></i>
              Pending Bios
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/admin/posts">
              <i class="bi bi-chat-dots me-2"></i>
              Post Moderation
            </a>
          </li>
        </ul>
      </div>
    </nav>

    <!-- Main content -->
    <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
      <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2">Pending Bio Approvals</h1>
        <span class="badge bg-warning"><%= users.length %> Pending</span>
      </div>

      <!-- Pending Bios Table -->
      <div class="card">
        <div class="card-body">
          <% if (users && users.length > 0) { %>
            <div class="table-responsive">
              <table class="table table-striped table-hover">
                <thead>
                  <tr>
                    <th>User</th>
                    <th>Email</th>
                    <th>Bio Content</th>
                    <th>Submitted</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <% users.forEach(user => { %>
                    <tr>
                      <td>
                        <strong><%= user.username %></strong>
                        <br><small class="text-muted">ID: <%= user.user_id %></small>
                      </td>
                      <td><%= user.email %></td>
                      <td>
                        <div class="bio-content" style="max-width: 300px;">
                          <p class="mb-2" style="white-space: pre-wrap;"><%= user.bio %></p>
                          <small class="text-muted"><%= user.bio.length %> characters</small>
                        </div>
                      </td>
                      <td><%= new Date(user.created_at).toLocaleDateString() %></td>
                      <td>
                        <div class="btn-group btn-group-sm">
                          <button class="btn btn-success approve-bio-btn" 
                                  data-user-id="<%= user.user_id %>">
                            <i class="bi bi-check-lg"></i> Approve
                          </button>
                          <button class="btn btn-outline-secondary edit-bio-btn" 
                                  data-user-id="<%= user.user_id %>"
                                  data-current-bio="<%= user.bio %>">
                            <i class="bi bi-pencil"></i> Edit
                          </button>
                        </div>
                      </td>
                    </tr>
                  <% }); %>
                </tbody>
              </table>
            </div>
          <% } else { %>
            <div class="text-center py-5">
              <i class="bi bi-check-circle text-success" style="font-size: 3rem;"></i>
              <h4 class="mt-3">No Pending Bios</h4>
              <p class="text-muted">All user bios have been approved.</p>
            </div>
          <% } %>
        </div>
      </div>
    </main>
  </div>
</div>

<script>
// Use the same JavaScript functions from users.ejs for bio approval and editing
document.addEventListener('DOMContentLoaded', function() {
  // Bio approval
  document.querySelectorAll('.approve-bio-btn').forEach(button => {
    button.addEventListener('click', function() {
      const userId = this.dataset.userId;
      approveUserBio(userId, this);
    });
  });

  // Bio editing
  document.querySelectorAll('.edit-bio-btn').forEach(button => {
    button.addEventListener('click', function() {
      const userId = this.dataset.userId;
      const currentBio = this.dataset.currentBio;
      
      const newBio = prompt('Edit bio (max 500 characters):', currentBio);
      
      if (newBio !== null && newBio.length <= 500) {
        updateUserBioAdmin(userId, newBio, this);
      } else if (newBio && newBio.length > 500) {
        alert('Bio must be 500 characters or less');
      }
    });
  });

  async function approveUserBio(userId, buttonElement) {
    const originalText = buttonElement.innerHTML;
    buttonElement.innerHTML = '<i class="bi bi-arrow-repeat spinner-border spinner-border-sm"></i>';
    buttonElement.disabled = true;

    try {
      const response = await fetch(`/admin/users/${userId}/bio/approve`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        }
      });

      const result = await response.json();

      if (result.success) {
        showToast('Bio approved successfully!', 'success');
        
        // Remove the entire row
        buttonElement.closest('tr').remove();
        
        // Update pending count
        const pendingCount = document.querySelectorAll('tbody tr').length;
        document.querySelector('.badge').textContent = pendingCount + ' Pending';
        
      } else {
        showToast('Error approving bio: ' + result.error, 'error');
      }
    } catch (error) {
      console.error('Error:', error);
      showToast('Error approving bio', 'error');
    } finally {
      buttonElement.innerHTML = originalText;
      buttonElement.disabled = false;
    }
  }

  async function updateUserBioAdmin(userId, newBio, buttonElement) {
    const originalText = buttonElement.innerHTML;
    buttonElement.innerHTML = '<i class="bi bi-arrow-repeat spinner-border spinner-border-sm"></i>';
    buttonElement.disabled = true;

    try {
      const response = await fetch(`/admin/users/${userId}/bio`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ bio: newBio })
      });

      const result = await response.json();

      if (result.success) {
        showToast('Bio updated successfully!', 'success');
        
        // Update the displayed bio
        const bioCell = buttonElement.closest('tr').querySelector('.bio-content p');
        bioCell.textContent = newBio;
        
        // Update character count
        const charCount = buttonElement.closest('tr').querySelector('.bio-content small');
        charCount.textContent = newBio.length + ' characters';
        
        // Update button data attribute
        buttonElement.dataset.currentBio = newBio;
        
      } else {
        showToast('Error updating bio: ' + result.error, 'error');
      }
    } catch (error) {
      console.error('Error:', error);
      showToast('Error updating bio', 'error');
    } finally {
      buttonElement.innerHTML = originalText;
      buttonElement.disabled = false;
    }
  }

  function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-white bg-${type === 'success' ? 'success' : 'danger'} border-0`;
    toast.innerHTML = `
      <div class="d-flex">
        <div class="toast-body">${message}</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    `;
    
    document.body.appendChild(toast);
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
    
    toast.addEventListener('hidden.bs.toast', () => {
      toast.remove();
    });
  }
});
</script>

<%- include('../partials/admin-footer') %>