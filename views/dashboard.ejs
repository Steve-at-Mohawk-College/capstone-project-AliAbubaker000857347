
<%- include('partials/header', {title: 'Pet Dashboard' }) %>

<div class="row">
  <div class="col-12">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <div>
        <h1 class="h3 mb-1">Welcome, <%= username %>!</h1>
        <p class="text-muted mb-0">üêæ Here's your pet dashboard</p>
      </div>
      <div class="d-flex">
        <a href="/pets/add" class="btn btn-custom me-2">
          <i class="bi bi-plus-circle"></i> Add Pet
        </a>
        <a href="/schedule-task" class="btn btn-outline-custom">
          <i class="bi bi-plus-circle"></i> Add Task
        </a>
      </div>
    </div>
  </div>
</div>

<!-- Professional Filter Section -->
<div class="filter-section">
  <div class="row align-items-center mb-3">
    <div class="col">
      <h5 class="mb-0"><i class="bi bi-funnel me-2"></i>Filter Pets</h5>
      <p class="text-muted mb-0 small">Refine your pet list by specific criteria</p>
    </div>
    <div class="col-auto">
      <span class="badge bg-primary filter-results" id="filterResults">
        Showing all <%= pets ? pets.length : 0 %> pets
      </span>
    </div>
  </div>
  
  <form id="petFilterForm">
    <div class="row filter-row g-3">
      <!-- Species Filter -->
      <div class="col-md-3 filter-group">
        <label class="form-label small fw-semibold">Species</label>
        <select class="form-select" id="filterSpecies">
          <option value="">All Species</option>
          <option value="dog">Dog</option>
          <option value="cat">Cat</option>
          <option value="bird">Bird</option>
          <option value="other">Other</option>
        </select>
      </div>

      <!-- Age Range Filter -->
      <div class="col-md-3 filter-group">
        <label class="form-label small fw-semibold">Age Range (years)</label>
        <div class="input-group">
          <input type="number" class="form-control" id="filterAgeMin" placeholder="Min" min="0" step="0.1">
          <span class="input-group-text">-</span>
          <input type="number" class="form-control" id="filterAgeMax" placeholder="Max" min="0" step="0.1">
        </div>
      </div>

      <!-- Weight Range Filter -->
      <div class="col-md-3 filter-group">
        <label class="form-label small fw-semibold">Weight Range (kg)</label>
        <div class="input-group">
          <input type="number" class="form-control" id="filterWeightMin" placeholder="Min" min="0" step="0.1">
          <span class="input-group-text">-</span>
          <input type="number" class="form-control" id="filterWeightMax" placeholder="Max" min="0" step="0.1">
        </div>
      </div>

      <!-- Gender Filter -->
      <div class="col-md-2 filter-group">
        <label class="form-label small fw-semibold">Gender</label>
        <select class="form-select" id="filterGender">
          <option value="">All Genders</option>
          <option value="male">Male</option>
          <option value="female">Female</option>
          <option value="other">Other</option>
        </select>
      </div>

      <!-- Filter Actions -->
      <div class="col-md-1 filter-group">
        <label class="form-label small fw-semibold invisible">Actions</label>
        <div class="filter-actions">
          <button type="button" class="btn btn-primary" id="applyFilters">
            <i class="bi bi-funnel"></i>
          </button>
          <button type="button" class="btn btn-outline-secondary" id="clearFilters" title="Clear all filters">
            <i class="bi bi-arrow-clockwise"></i>
          </button>
        </div>
      </div>
    </div>

    <!-- Active Filters Display -->
    <div class="row mt-3">
      <div class="col-12">
        <div id="activeFilters" class="d-flex flex-wrap gap-2"></div>
      </div>
    </div>
  </form>
</div>

<!-- Stats Overview -->
<div class="row mb-4">
  <div class="col-md-4 mb-3">
    <div class="card card-custom h-100">
      <div class="card-body text-center">
        <div class="d-flex align-items-center justify-content-center">
          <div class="bg-primary bg-opacity-10 p-3 rounded-circle me-3">
            <i class="bi bi-heart-fill text-primary" style="font-size: 1.5rem;"></i>
          </div>
          <div>
            <h3 class="h2 mb-0" id="totalPetsCount">
              <%= pets ? pets.length : 0 %>
            </h3>
            <p class="text-muted mb-0">Total Pets</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-md-4 mb-3">
    <div class="card card-custom h-100">
      <div class="card-body text-center">
        <div class="d-flex align-items-center justify-content-center">
          <div class="bg-warning bg-opacity-10 p-3 rounded-circle me-3">
            <i class="bi bi-list-check text-warning" style="font-size: 1.5rem;"></i>
          </div>
          <div>
            <h3 class="h2 mb-0">
              <%= tasks ? tasks.length : 0 %>
            </h3>
            <p class="text-muted mb-0">Tasks Due</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-md-4 mb-3">
    <div class="card card-custom h-100">
      <div class="card-body text-center">
        <div class="d-flex align-items-center justify-content-center">
          <div class="bg-success bg-opacity-10 p-3 rounded-circle me-3">
            <i class="bi bi-people-fill text-success" style="font-size: 1.5rem;"></i>
          </div>
          <div>
            <h3 class="h2 mb-0">1</h3>
            <p class="text-muted mb-0">Owner</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="row">
  <!-- Pets Section -->
  <div class="col-lg-6 mb-4">
    <div class="card card-custom h-100">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h2 class="h5 mb-0">Your Pets</h2>
        <div>
          <a href="/pets/add" class="btn btn-sm btn-outline-custom">
            <i class="bi bi-plus"></i> Add
          </a>
        </div>
      </div>
      <div class="card-body">
        <div id="petsListContainer">
          <% if (pets && pets.length> 0) { %>
            <div class="list-group list-group-flush" id="petsList">
              <% pets.forEach(pet=> { %>
                <div class="list-group-item border-0 px-0 py-3 pet-card" 
                     data-species="<%= pet.species || '' %>" 
                     data-age="<%= pet.age || 0 %>" 
                     data-weight="<%= pet.weight || 0 %>" 
                     data-gender="<%= pet.gender || '' %>">
                  <div class="d-flex align-items-center">
                    <div class="flex-shrink-0">
                      <div class="bg-primary bg-opacity-10 p-3 rounded-circle">
                        <i class="bi bi-heart-fill text-primary"></i>
                      </div>
                    </div>
                    <div class="flex-grow-1 ms-3">
                      <h5 class="mb-1">
                        <%= pet.name %>
                      </h5>
                      <p class="text-muted mb-0 small">
                        <%= pet.breed || 'Unknown breed' %> ‚Ä¢
                        <!-- Enhanced age display -->
                        <% if (pet.age !== null && pet.age !== undefined) { %>
                          <%
                            const ageValue = parseFloat(pet.age);
                            let ageDisplay;
                            
                            if (ageValue < 1) {
                              // Show months for values less than 1 year
                              const months = Math.round(ageValue * 12);
                              ageDisplay = months + ' month' + (months !== 1 ? 's' : '');
                            } else if (Number.isInteger(ageValue)) {
                              // Whole number - show without decimals
                              ageDisplay = ageValue + ' years';
                            } else {
                              // Decimal value 1 or greater - show with one decimal place
                              ageDisplay = ageValue.toFixed(1) + ' years';
                            }
                          %>
                          <span class="pet-age"><%= ageDisplay %></span>
                        <% } else { %>
                          <span class="pet-age">Age unknown</span>
                        <% } %> ‚Ä¢
                        <span class="pet-weight">
                          <%= pet.weight ? pet.weight + ' kg' : 'Weight unknown' %>
                        </span> ‚Ä¢
                        <span class="pet-species"><%= pet.species || 'Unknown' %></span>
                      </p>

                      <!-- Edit Form (Hidden by default) -->
                      <div class="edit-form" id="edit-form-<%= pet.pet_id %>">
                        <h6 class="mb-2">Edit Pet Details</h6>
                        <div class="row">
                          <div class="col-md-6 edit-field">
                            <label for="edit-age-<%= pet.pet_id %>" class="form-label small">Age (years)</label>
                            <input type="number" class="form-control form-control-sm" 
                                   id="edit-age-<%= pet.pet_id %>" 
                                   value="<%= pet.age || '' %>" 
                                   min="0.1" step="0.1">
                          </div>
                          <div class="col-md-6 edit-field">
                            <label for="edit-weight-<%= pet.pet_id %>" class="form-label small">Weight (kg)</label>
                            <input type="number" class="form-control form-control-sm" 
                                   id="edit-weight-<%= pet.pet_id %>" 
                                   value="<%= pet.weight || '' %>" 
                                   min="0" step="0.1">
                          </div>
                        </div>
                        <div class="d-flex gap-2 mt-2">
                          <button class="btn btn-sm btn-success save-edit-btn" 
                                  data-pet-id="<%= pet.pet_id %>">
                            <i class="bi bi-check"></i> Save
                          </button>
                          <button class="btn btn-sm btn-secondary cancel-edit-btn" 
                                  data-pet-id="<%= pet.pet_id %>">
                            <i class="bi bi-x"></i> Cancel
                          </button>
                        </div>
                      </div>
                    </div>
                    <div class="flex-shrink-0">
                      <span class="badge bg-light text-dark me-2 pet-gender">
                        <%= pet.gender || 'Unknown' %>
                      </span>
                      <!-- Edit Pet Button -->
                      <button class="btn btn-sm btn-outline-primary edit-btn me-2" 
                              data-pet-id="<%= pet.pet_id %>">
                        <i class="bi bi-pencil"></i>
                      </button>
                      <!-- Remove Pet Button -->
                      <button class="btn btn-sm btn-outline-danger remove-btn" 
                              data-type="pet" data-id="<%= pet.pet_id %>" 
                              data-name="<%= pet.name %>">
                        <i class="bi bi-trash"></i>
                      </button>
                    </div>
                  </div>
                </div>
              <% }); %>
            </div>
          <% } else { %>
            <div class="text-center py-4 no-pets-message">
              <div class="bg-light rounded-circle p-4 d-inline-block mb-3">
                <i class="bi bi-heart text-muted" style="font-size: 2rem;"></i>
              </div>
              <h5 class="text-muted">No pets yet</h5>
              <p class="text-muted mb-3">Add your first pet to get started</p>
              <a href="/pets/add" class="btn btn-custom">Add Your First Pet</a>
            </div>
          <% } %>
        </div>
      </div>
    </div>
  </div>

  <!-- Tasks Section -->
  <div class="col-lg-6 mb-4">
    <div class="card card-custom h-100">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h2 class="h5 mb-0">Upcoming Tasks</h2>
            <a href="/schedule-task" class="btn btn-sm btn-outline-custom">
                <i class="bi bi-plus"></i> Add
            </a>
        </div>
        <div class="card-body">
            <% if (tasks && tasks.length > 0) { %>
                <div class="list-group list-group-flush">
                    <% tasks.forEach(task => { %>
                        <div class="list-group-item border-0 px-0 py-3">
                            <div class="d-flex align-items-center">
                                <div class="flex-shrink-0">
                                    <div class="bg-warning bg-opacity-10 p-3 rounded-circle">
                                        <i class="bi bi-list-check text-warning"></i>
                                    </div>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <h5 class="mb-1">
                                        <%= task.title %>
                                        <% if (task.description) { %>
                                            <button class="btn btn-sm btn-link p-0 ms-1 toggle-description" data-task-id="<%= task.task_id %>" title="Toggle description">
                                                <i class="bi bi-chevron-down"></i>
                                            </button>
                                        <% } %>
                                    </h5>
                                    <p class="text-muted mb-0 small">
    For: <%= task.pet_name %> ‚Ä¢ 
    Due: <span class="due-date" data-due-date="<%= task.due_date %>">
        <%= new Date(task.due_date).toLocaleString('en-US', { 
            year: 'numeric', 
            month: 'short', 
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
            timeZoneName: 'short'
        }) %>
    </span>
</p>
                                    <% if (task.description) { %>
                                        <div class="task-description mt-2" id="description-<%= task.task_id %>" style="display: none;">
                                            <p class="text-muted mb-0 small">
                                                <i class="bi bi-chat-text"></i> <%= task.description %>
                                            </p>
                                        </div>
                                    <% } %>

                                    <!-- Task Edit Form (Hidden by default) -->
                                    <div class="edit-task-form mt-3" id="edit-task-form-<%= task.task_id %>" style="display: none;">
                                        <h6 class="mb-2">Edit Task</h6>
                                        <div class="row">
                                            <div class="col-md-6 edit-field">
                                                <label for="edit-task-title-<%= task.task_id %>" class="form-label small">Title *</label>
                                                <input type="text" class="form-control form-control-sm" 
                                                       id="edit-task-title-<%= task.task_id %>" 
                                                       value="<%= task.title %>" required>
                                            </div>
                                            <div class="col-md-6 edit-field">
                                                <label for="edit-task-priority-<%= task.task_id %>" class="form-label small">Priority</label>
                                                <select class="form-select form-select-sm" id="edit-task-priority-<%= task.task_id %>">
                                                    <option value="low" <%= task.priority === 'low' ? 'selected' : '' %>>Low</option>
                                                    <option value="medium" <%= task.priority === 'medium' ? 'selected' : '' %>>Medium</option>
                                                    <option value="high" <%= task.priority === 'high' ? 'selected' : '' %>>High</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="edit-field">
                                            <label for="edit-task-description-<%= task.task_id %>" class="form-label small">Description</label>
                                            <textarea class="form-control form-control-sm" 
                                                      id="edit-task-description-<%= task.task_id %>" 
                                                      rows="2"><%= task.description || '' %></textarea>
                                        </div>
                                        <div class="edit-field">
                                            <label for="edit-task-due-date-<%= task.task_id %>" class="form-label small">Due Date *</label>
                                            <input type="datetime-local" class="form-control form-control-sm" 
                                                   id="edit-task-due-date-<%= task.task_id %>" 
                                                   value="<%= new Date(task.due_date).toISOString().slice(0, 16) %>" required>
                                        </div>
                                        <div class="d-flex gap-2 mt-2">
                                            <button class="btn btn-sm btn-success save-task-edit-btn" 
                                                    data-task-id="<%= task.task_id %>">
                                                <i class="bi bi-check"></i> Save
                                            </button>
                                            <button class="btn btn-sm btn-secondary cancel-task-edit-btn" 
                                                    data-task-id="<%= task.task_id %>">
                                                <i class="bi bi-x"></i> Cancel
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="flex-shrink-0">
                                    <span class="badge bg-<%= task.priority === 'high' ? 'danger' : task.priority === 'medium' ? 'warning' : 'info' %> me-2">
                                        <%= task.priority %>
                                    </span>
                                    <!-- Edit Task Button -->
                                    <button class="btn btn-sm btn-outline-primary edit-task-btn me-2" 
                                            data-task-id="<%= task.task_id %>">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <!-- Remove Task Button -->
                                    <button class="btn btn-sm btn-outline-danger remove-btn" 
                                            data-type="task" data-id="<%= task.task_id %>" 
                                            data-name="<%= task.title %>">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    <% }); %>
                </div>
            <% } else { %>
                <div class="text-center py-4">
                    <div class="bg-light rounded-circle p-4 d-inline-block mb-3">
                        <i class="bi bi-list-check text-muted" style="font-size: 2rem;"></i>
                    </div>
                    <h5 class="text-muted">No upcoming tasks</h5>
                    <p class="text-muted mb-3">Schedule your first task</p>
                    <a href="/schedule-task" class="btn btn-custom">Schedule a Task</a>
                </div>
            <% } %>
        </div>
    </div>
  </div>
</div>

<!-- Quick Actions -->
<div class="row">
  <div class="col-12">
    <div class="card card-custom">
      <div class="card-header">
        <h2 class="h5 mb-0">Quick Actions</h2>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-sm-6 col-md-3 mb-3">
            <a href="/pets/add" class="btn btn-outline-custom w-100 d-flex flex-column align-items-center py-3">
              <i class="bi bi-plus-circle mb-2" style="font-size: 1.5rem;"></i>
              <span>Add Pet</span>
            </a>
          </div>
          <div class="col-sm-6 col-md-3 mb-3">
            <a href="/schedule-task" class="btn btn-outline-custom w-100 d-flex flex-column align-items-center py-3">
              <i class="bi bi-calendar-plus mb-2" style="font-size: 1.5rem;"></i>
              <span>Schedule Task</span>
            </a>
          </div>
          <div class="col-sm-6 col-md-3 mb-3">
            <a href="/health-tracker/add" class="btn btn-outline-custom w-100 d-flex flex-column align-items-center py-3">
              <i class="bi bi-heart-pulse mb-2" style="font-size: 1.5rem;"></i>
              <span>Health Tracker</span>
            </a>
          </div>
          <div class="col-sm-6 col-md-3 mb-3">
            <a href="/community" class="btn btn-outline-custom w-100 d-flex flex-column align-items-center py-3">
              <i class="bi bi-people mb-2" style="font-size: 1.5rem;"></i>
              <span>Community</span>
            </a>
          </div>
          <div class="col-sm-6 col-md-3 mb-3">
  <a href="/task-overview" class="btn btn-outline-custom w-100 d-flex flex-column align-items-center py-3">
    <i class="bi bi-list-check mb-2" style="font-size: 1.5rem;"></i>
    <span>Task Overview</span>
  </a>
</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Confirmation Modal -->
<div class="modal fade" id="confirmationModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Confirm Removal</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p id="confirmationMessage">Are you sure you want to remove this item?</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="confirmRemoveBtn">Remove</button>
      </div>
    </div>
  </div>
</div>


<!-- Notifications Bell -->
<div class="position-fixed top-0 end-0 p-3" style="z-index: 1050;">
  <div class="dropdown">
    <button class="btn btn-light btn-sm position-relative dropdown-toggle" 
            id="notificationDropdown" 
            data-bs-toggle="dropdown" 
            aria-expanded="false">
      <i class="bi bi-bell"></i>
      <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" 
            id="notificationBadge" style="display: none;">
        0
      </span>
    </button>
    <ul class="dropdown-menu dropdown-menu-end" style="width: 350px; max-height: 400px; overflow-y: auto;">
      <li class="dropdown-header d-flex justify-content-between align-items-center">
        <span>Notifications</span>
        <button class="btn btn-sm btn-outline-secondary" id="markAllReadBtn">
          Mark all read
        </button>
      </li>
      <li><hr class="dropdown-divider"></li>
      <div id="notificationsList">
        <li class="px-3 py-2 text-center text-muted">
          <div class="spinner-border spinner-border-sm" role="status"></div>
          <span class="ms-2">Loading notifications...</span>
        </li>
      </div>
      <li><hr class="dropdown-divider"></li>
      <li>
        <a class="dropdown-item text-center" href="/notifications">
          <i class="bi bi-list"></i> View all notifications
        </a>
      </li>
    </ul>
  </div>
</div>



<script src="/js/dashboard.js"></script>


<script src="/js/dashboard-filters.js"></script>

<script>
// Notification system
class NotificationSystem {
  constructor() {
    this.checkInterval = null;
    this.init();
  }

  init() {
    this.loadNotifications();
    this.setupEventListeners();
    
    // Check for new notifications every 30 seconds
    this.checkInterval = setInterval(() => {
      this.loadNotifications();
    }, 30000);
  }

  async loadNotifications() {
    try {
      const response = await fetch('/notifications?limit=10');
      const notifications = await response.json();
      
      this.updateNotificationBadge(notifications);
      this.renderNotifications(notifications);
    } catch (error) {
      console.error('Error loading notifications:', error);
    }
  }

  updateNotificationBadge(notifications) {
    const badge = document.getElementById('notificationBadge');
    const unreadCount = notifications.filter(n => !n.is_read).length;
    
    if (unreadCount > 0) {
      badge.textContent = unreadCount;
      badge.style.display = 'block';
    } else {
      badge.style.display = 'none';
    }
  }

  renderNotifications(notifications) {
    const container = document.getElementById('notificationsList');
    
    if (notifications.length === 0) {
      container.innerHTML = `
        <li class="px-3 py-3 text-center text-muted">
          <i class="bi bi-bell-slash" style="font-size: 1.5rem;"></i>
          <div class="mt-2">No notifications</div>
        </li>
      `;
      return;
    }

    container.innerHTML = notifications.map(notification => `
      <li class="dropdown-item ${notification.is_read ? '' : 'bg-light'} p-3 border-bottom">
        <div class="d-flex align-items-start">
          <div class="flex-grow-1">
            <h6 class="mb-1 ${notification.is_read ? '' : 'fw-bold'}">${notification.title}</h6>
            <p class="mb-1 small">${notification.message}</p>
            <small class="text-muted">${new Date(notification.created_at).toLocaleString()}</small>
          </div>
          <div class="flex-shrink-0 ms-2">
            ${!notification.is_read ? `
              <button class="btn btn-sm btn-outline-primary mark-read-btn" 
                      data-id="${notification.notification_id}" 
                      title="Mark as read">
                <i class="bi bi-check"></i>
              </button>
            ` : ''}
          </div>
        </div>
      </li>
    `).join('');

    // Add event listeners to mark-as-read buttons
    container.querySelectorAll('.mark-read-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        this.markAsRead(btn.dataset.id);
      });
    });
  }

  async markAsRead(notificationId) {
    try {
      await fetch(`/notifications/${notificationId}/read`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' }
      });
      
      // Reload notifications
      this.loadNotifications();
    } catch (error) {
      console.error('Error marking notification as read:', error);
    }
  }

  async markAllAsRead() {
    try {
      await fetch('/notifications/read-all', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' }
      });
      
      this.loadNotifications();
    } catch (error) {
      console.error('Error marking all notifications as read:', error);
    }
  }

  setupEventListeners() {
    document.getElementById('markAllReadBtn')?.addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();
      this.markAllAsRead();
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
      const dropdown = document.getElementById('notificationDropdown');
      if (!dropdown.contains(e.target)) {
        const dropdownMenu = document.querySelector('.dropdown-menu');
        dropdownMenu.classList.remove('show');
      }
    });
  }

  destroy() {
    if (this.checkInterval) {
      clearInterval(this.checkInterval);
    }
  }
}

// Initialize notification system when page loads
document.addEventListener('DOMContentLoaded', () => {
  window.notificationSystem = new NotificationSystem();
});
</script>


<%- include('partials/footer') %>



    <!-- Add Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">