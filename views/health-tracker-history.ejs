<%- include('partials/header', {title: 'Health Tracker History' }) %>
  <style>
    /* Ensure proper text colors for light and dark modes */
    body {
      background-color: var(--light);
      color: var(--dark);
    }

    /* Fix for health record cards */
    .health-record-card {
      background-color: var(--light);
      color: var(--dark);
      border: 1px solid var(--light-gray);
    }

    /* Fix for modal in light mode */
    .modal-content {
      background-color: var(--light) !important;
      color: var(--dark) !important;
    }

    .modal-header {
      background-color: var(--light-gray) !important;
      border-bottom: 1px solid var(--glass-border) !important;
      color: var(--dark) !important;
    }

    /* Fix for form controls in light mode */
    .form-control,
    .form-select {
      background-color: var(--light) !important;
      color: var(--dark) !important;
      border-color: var(--light-gray) !important;
    }

    .form-control:focus,
    .form-select:focus {
      background-color: var(--light) !important;
      color: var(--dark) !important;
      border-color: var(--primary) !important;
    }

    /* Fix for table in light mode */
    .table {
      color: var(--dark) !important;
    }

    .table-striped>tbody>tr:nth-of-type(odd) {
      background-color: rgba(67, 97, 238, 0.05) !important;
    }

    /* Fix for alert in light mode */
    .alert {
      background-color: var(--light) !important;
      color: var(--dark) !important;
      border: 1px solid var(--light-gray) !important;
    }

    /* Fix for text-muted in both themes */
    .text-muted {
      color: var(--gray) !important;
    }

    /* Fix for buttons */
    .btn-outline-primary {
      color: var(--primary) !important;
      border-color: var(--primary) !important;
    }

    .btn-outline-primary:hover {
      background-color: var(--primary) !important;
      color: white !important;
    }

    .btn-outline-warning {
      color: #ffc107 !important;
      border-color: #ffc107 !important;
    }

    .btn-outline-warning:hover {
      background-color: #ffc107 !important;
      color: #000 !important;
    }

    .btn-outline-danger {
      color: #dc3545 !important;
      border-color: #dc3545 !important;
    }

    .btn-outline-danger:hover {
      background-color: #dc3545 !important;
      color: white !important;
    }

    /* Fix for card headers */
    .card-header {
      background-color: var(--light-gray) !important;
      color: var(--dark) !important;
      border-bottom: 1px solid var(--glass-border) !important;
    }

    /* Fix for bootstrap theme colors in light mode */
    [data-theme="light"] {
      --bs-body-color: #212529 !important;
      --bs-body-bg: #ffffff !important;
    }

    /* Force dark theme override for health record detail modal */
    #recordDetails {
      background-color: var(--light) !important;
      color: var(--dark) !important;
    }

    #recordDetails h6,
    #recordDetails p,
    #recordDetails strong {
      color: var(--dark) !important;
    }

    #recordDetails .bg-light {
      background-color: var(--light-gray) !important;
      color: var(--dark) !important;
    }

    /* Mobile-specific fixes */
    @media (max-width: 768px) {
      .health-record-card {
        background-color: var(--light) !important;
        color: var(--dark) !important;
      }

      .health-record-card .text-muted {
        color: var(--gray) !important;
      }

      .health-record-card .fw-medium {
        color: var(--dark) !important;
      }

      /* Ensure mobile header is visible */
      .d-xl-none {
        background-color: var(--light) !important;
        color: var(--dark) !important;
      }

      .d-xl-none h1 {
        color: var(--dark) !important;
      }
    }

    #recordModal .modal-body {
      background-color: var(--light) !important;
    }

    #recordModal .modal-body * {
      color: var(--dark) !important;
    }

    #recordModal .modal-body .bg-light {
      background-color: var(--light-gray) !important;
    }

    /* Dark mode specific overrides */
    [data-theme="dark"] .health-record-card {
      background-color: #2d2d2d !important;
    }

    [data-theme="dark"] .modal-content {
      background-color: #2d2d2d !important;
    }

    [data-theme="dark"] .table-striped>tbody>tr:nth-of-type(odd) {
      background-color: rgba(255, 255, 255, 0.05) !important;
    }
  </style>

  <div class="container-fluid">
    <div class="row">
      <div class="col-12">
        <!-- This section will be hidden on screens less than 1000px -->
        <div class="d-none d-xl-flex justify-content-between align-items-center mb-4">
          <h1 class="h3">Health Tracker History</h1>
          <a href="/health-tracker/add" class="btn btn-primary">
            <i class="bi bi-plus-circle"></i> Add New Record
          </a>
        </div>

        <!-- Mobile header (shown only on screens less than 1000px) -->
        <div class="d-xl-none mb-4 mt-5 pt-5">
          <div class="text-center">
            <h1 class="h4">Health Tracker History</h1>
          </div>
          <div class="text-center mt-2">
            <a href="/health-tracker/add" class="btn btn-primary btn-sm">
              <i class="bi bi-plus-circle"></i> Add New Record
            </a>
          </div>
        </div>

        <% if (typeof message !=='undefined' && message) { %>
          <div class="alert alert-success alert-dismissible fade show">
            <%= message %>
              <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          </div>
          <% } %>

            <% if (pets.length===0) { %>
              <div class="alert alert-info">
                <h4>No Pets Found</h4>
                <p>You haven't added any pets yet. <a href="/pets/add">Add your first pet</a> to start tracking health
                  records.</p>
              </div>
              <% } else { %>
                <% pets.forEach(pet=> { %>
                  <div class="card mb-4">
                    <div class="card-header bg-light">
                      <h5 class="card-title mb-0">
                        <i class="bi bi-heart-pulse text-danger"></i>
                        <%= pet.name %> - Health History
                      </h5>
                    </div>
                    <div class="card-body">
                      <% const records=healthRecords[pet.pet_id] || []; %>
                        <% if (records.length===0) { %>
                          <div class="text-center py-4">
                            <i class="bi bi-clipboard-x display-4 text-muted"></i>
                            <p class="mt-3 text-muted">No health records found for <%= pet.name %>
                            </p>
                            <a href="/health-tracker/add?pet_id=<%= pet.pet_id %>" class="btn btn-outline-primary">
                              Add First Health Record
                            </a>
                          </div>
                          <% } else { %>
                            <!-- Desktop Table (hidden on mobile) -->
                            <div class="d-none d-lg-block">
                              <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                  <thead>
                                    <tr>
                                      <th>Date</th>
                                      <th>Weight</th>
                                      <th>Diet</th>
                                      <th>Vet Visit</th>
                                      <th>Vaccination</th>
                                      <th>Next Vaccination</th>
                                      <th>Actions</th>
                                    </tr>
                                  </thead>
                                  <tbody>
                                    <% records.forEach(record=> { %>
                                      <tr>
                                        <td>
                                          <strong>
                                            <%= new Date(record.date_recorded).toLocaleDateString() %>
                                          </strong>
                                        </td>
                                        <td>
                                          <% if (record.weight) { %>
                                            <%= record.weight %> kg
                                              <% } else { %>
                                                <span class="text-muted">-</span>
                                                <% } %>
                                        </td>
                                        <td>
                                          <% if (record.diet) { %>
                                            <%= record.diet.substring(0, 30) %>
                                              <%= record.diet.length> 30 ? '...' : '' %>
                                                <% } else { %>
                                                  <span class="text-muted">-</span>
                                                  <% } %>
                                        </td>
                                        <td>
                                          <% if (record.vet_visit_date) { %>
                                            <%= new Date(record.vet_visit_date).toLocaleDateString() %>
                                              <% } else { %>
                                                <span class="text-muted">-</span>
                                                <% } %>
                                        </td>
                                        <td>
                                          <% if (record.vaccination_date) { %>
                                            <%= new Date(record.vaccination_date).toLocaleDateString() %>
                                              <% } else { %>
                                                <span class="text-muted">-</span>
                                                <% } %>
                                        </td>
                                        <td>
                                          <% if (record.next_vaccination_date) { %>
                                            <% const nextVaccDate=new Date(record.next_vaccination_date); %>
                                              <% const today=new Date(); %>
                                                <span class="<%= nextVaccDate < today ? 'text-danger' : '' %>">
                                                  <%= nextVaccDate.toLocaleDateString() %>
                                                    <% if (nextVaccDate < today) { %>
                                                      <br><small class="text-danger">Overdue</small>
                                                      <% } %>
                                                </span>
                                                <% } else { %>
                                                  <span class="text-muted">-</span>
                                                  <% } %>
                                        </td>
                                        <td>
                                          <div class="btn-group btn-group-sm">
                                            <button class="btn btn-outline-primary view-record"
                                              data-record-id="<%= record.health_id %>" title="View Details">
                                              <i class="bi bi-eye"></i>
                                            </button>
                                            <button class="btn btn-outline-warning edit-record"
                                              data-record-id="<%= record.health_id %>" title="Edit Record">
                                              <i class="bi bi-pencil"></i>
                                            </button>
                                            <button class="btn btn-outline-danger delete-record"
                                              data-record-id="<%= record.health_id %>" data-pet-name="<%= pet.name %>"
                                              data-record-date="<%= new Date(record.date_recorded).toLocaleDateString() %>"
                                              title="Delete Record">
                                              <i class="bi bi-trash"></i>
                                            </button>
                                          </div>
                                        </td>
                                      </tr>
                                      <% }); %>
                                  </tbody>
                                </table>
                              </div>
                            </div>

                            <!-- Mobile Cards (shown on mobile) -->
                            <div class="d-lg-none">
                              <div class="row g-3">
                                <% records.forEach(record=> { %>
                                  <div class="col-12">
                                    <div class="card health-record-card">
                                      <div class="card-body">
                                        <!-- Header with date and actions -->
                                        <div class="d-flex justify-content-between align-items-start mb-3">
                                          <h6 class="card-title mb-0 text-primary">
                                            <strong>
                                              <%= new Date(record.date_recorded).toLocaleDateString() %>
                                            </strong>
                                          </h6>
                                          <div class="btn-group btn-group-sm">
                                            <button class="btn btn-outline-primary view-record"
                                              data-record-id="<%= record.health_id %>" title="View Details">
                                              <i class="bi bi-eye"></i>
                                            </button>
                                            <button class="btn btn-outline-warning edit-record"
                                              data-record-id="<%= record.health_id %>" title="Edit Record">
                                              <i class="bi bi-pencil"></i>
                                            </button>
                                            <button class="btn btn-outline-danger delete-record"
                                              data-record-id="<%= record.health_id %>" data-pet-name="<%= pet.name %>"
                                              data-record-date="<%= new Date(record.date_recorded).toLocaleDateString() %>"
                                              title="Delete Record">
                                              <i class="bi bi-trash"></i>
                                            </button>
                                          </div>
                                        </div>

                                        <!-- Health data in compact grid -->
                                        <div class="row g-2">
                                          <!-- Weight -->
                                          <div class="col-6">
                                            <small class="text-muted">Weight</small>
                                            <div class="fw-medium">
                                              <% if (record.weight) { %>
                                                <%= record.weight %> kg
                                                  <% } else { %>
                                                    <span class="text-muted">-</span>
                                                    <% } %>
                                            </div>
                                          </div>

                                          <!-- Diet -->
                                          <div class="col-6">
                                            <small class="text-muted">Diet</small>
                                            <div class="fw-medium">
                                              <% if (record.diet) { %>
                                                <%= record.diet.substring(0, 15) %>
                                                  <%= record.diet.length> 15 ? '...' : '' %>
                                                    <% } else { %>
                                                      <span class="text-muted">-</span>
                                                      <% } %>
                                            </div>
                                          </div>

                                          <!-- Vet Visit -->
                                          <div class="col-6">
                                            <small class="text-muted">Vet Visit</small>
                                            <div class="fw-medium">
                                              <% if (record.vet_visit_date) { %>
                                                <%= new Date(record.vet_visit_date).toLocaleDateString() %>
                                                  <% } else { %>
                                                    <span class="text-muted">-</span>
                                                    <% } %>
                                            </div>
                                          </div>

                                          <!-- Vaccination -->
                                          <div class="col-6">
                                            <small class="text-muted">Vaccination</small>
                                            <div class="fw-medium">
                                              <% if (record.vaccination_date) { %>
                                                <%= new Date(record.vaccination_date).toLocaleDateString() %>
                                                  <% } else { %>
                                                    <span class="text-muted">-</span>
                                                    <% } %>
                                            </div>
                                          </div>

                                          <!-- Next Vaccination -->
                                          <div class="col-12">
                                            <small class="text-muted">Next Vaccination</small>
                                            <div class="fw-medium">
                                              <% if (record.next_vaccination_date) { %>
                                                <% const nextVaccDate=new Date(record.next_vaccination_date); %>
                                                  <% const today=new Date(); %>
                                                    <span class="<%= nextVaccDate < today ? 'text-danger' : '' %>">
                                                      <%= nextVaccDate.toLocaleDateString() %>
                                                        <% if (nextVaccDate < today) { %>
                                                          <small class="text-danger ms-1">(Overdue)</small>
                                                          <% } %>
                                                    </span>
                                                    <% } else { %>
                                                      <span class="text-muted">-</span>
                                                      <% } %>
                                            </div>
                                          </div>
                                        </div>
                                      </div>
                                    </div>
                                  </div>
                                  <% }); %>
                              </div>
                            </div>
                            <% } %>
                    </div>
                  </div>
                  <% }); %>
                    <% } %>
      </div>
    </div>
  </div>

  <!-- Record Details Modal -->
  <div class="modal fade" id="recordModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Health Record Details</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="recordDetails">
          <!-- Content loaded via JavaScript -->
        </div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // Apply theme styles immediately
      applyThemeStyles();
      // Listen for theme changes
      const observer = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
          if (mutation.attributeName === 'data-theme') {
            applyThemeStyles();
          }
        });
      });

      observer.observe(document.documentElement, { attributes: true });
    });

    function applyThemeStyles() {
      const theme = document.documentElement.getAttribute('data-theme') || 'light';
      const isDark = theme === 'dark';
      // Update all text elements to use correct colors
      document.querySelectorAll('.health-record-card, .modal-content, .card-body, .table, .alert, .form-control, .form-select').forEach(el => {
        el.style.setProperty('--bs-body-color', isDark ? '#f8f9fa' : '#212529', 'important');
        el.style.setProperty('--bs-body-bg', isDark ? '#1a1d21' : '#ffffff', 'important');
      });
    }

    // View record details
    document.querySelectorAll('.view-record').forEach(btn => {
      btn.addEventListener('click', async function () {
        const recordId = this.dataset.recordId;

        try {
          const response = await fetch(`/health/records/${recordId}`);
          const record = await response.json();

          if (response.ok) {
            const theme = document.documentElement.getAttribute('data-theme') || 'light';
            const isDark = theme === 'dark';
            const bgClass = isDark ? 'bg-dark text-light' : 'bg-light text-dark';

            document.getElementById('recordDetails').innerHTML = `
          <div class="row">
            <div class="col-md-6">
              <h6>Basic Information</h6>
              <p><strong>Pet:</strong> ${record.pet_name}</p>
              <p><strong>Record Date:</strong> ${new Date(record.date_recorded).toLocaleDateString()}</p>
              <p><strong>Weight:</strong> ${record.weight ? record.weight + ' kg' : 'Not recorded'}</p>
              <p><strong>Diet:</strong> ${record.diet || 'Not recorded'}</p>
            </div>
            <div class="col-md-6">
              <h6>Medical Information</h6>
              <p><strong>Vet Visit:</strong> ${record.vet_visit_date ? new Date(record.vet_visit_date).toLocaleDateString() : 'Not recorded'}</p>
              <p><strong>Vaccination:</strong> ${record.vaccination_date ? new Date(record.vaccination_date).toLocaleDateString() : 'Not recorded'}</p>
              <p><strong>Next Vaccination:</strong> ${record.next_vaccination_date ? new Date(record.next_vaccination_date).toLocaleDateString() : 'Not scheduled'}</p>
            </div>
          </div>
          ${record.medical_notes ? `
            <div class="row mt-3">
              <div class="col-12">
                <h6>Medical Notes</h6>
                <div class="border rounded p-3 ${bgClass}">
                  ${record.medical_notes}
                </div>
              </div>
            </div>
          ` : ''}
        `;

            new bootstrap.Modal(document.getElementById('recordModal')).show();
          } else {
            alert('Error loading record details');
          }
        } catch (error) {
          alert('Error loading record details');
        }
      });
    });

    // Edit record
    document.querySelectorAll('.edit-record').forEach(btn => {
      btn.addEventListener('click', function () {
        const recordId = this.dataset.recordId;
        window.location.href = `/health/edit/${recordId}`;
      });
    });

    // Delete record
    document.querySelectorAll('.delete-record').forEach(btn => {
      btn.addEventListener('click', function () {
        const recordId = this.dataset.recordId;
        const petName = this.dataset.petName;
        const recordDate = this.dataset.recordDate;

        if (confirm(`Are you sure you want to delete the health record for ${petName} from ${recordDate}?`)) {
          fetch(`/health/${recordId}`, {
            method: 'DELETE',
            headers: {
              'Content-Type': 'application/json'
            }
          })
            .then(response => response.json())
            .then(data => {
              if (data.ok) {
                location.reload();
              } else {
                alert('Error deleting record: ' + data.error);
              }
            })
            .catch(error => {
              alert('Error deleting record');
            });
        }
      });
    });
    window.addEventListener('load', function () {
      // Force theme application on load
      applyThemeStyles();

      // Add event listeners for all dynamically created elements
      document.body.addEventListener('click', function (e) {
        if (e.target.closest('.view-record')) {
          applyThemeStyles(); // Re-apply before showing modal
        }
      });
    });
  </script>

  <%- include('partials/footer') %>