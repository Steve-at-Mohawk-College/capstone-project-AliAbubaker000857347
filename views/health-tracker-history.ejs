<%- include('partials/header', {title: 'Health Tracker History'}) %>

<div class="container-fluid">
  <div class="row">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3">Health Tracker History</h1>
        <a href="/health-tracker/add" class="btn btn-primary">
          <i class="bi bi-plus-circle"></i> Add New Record
        </a>
      </div>

      <% if (typeof message !== 'undefined' && message) { %>
        <div class="alert alert-success alert-dismissible fade show">
          <%= message %>
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      <% } %>

      <% if (pets.length === 0) { %>
        <div class="alert alert-info">
          <h4>No Pets Found</h4>
          <p>You haven't added any pets yet. <a href="/pets/add">Add your first pet</a> to start tracking health records.</p>
        </div>
      <% } else { %>
        <% pets.forEach(pet => { %>
          <div class="card mb-4">
            <div class="card-header bg-light">
              <h5 class="card-title mb-0">
                <i class="bi bi-heart-pulse text-danger"></i>
                <%= pet.name %> - Health History
              </h5>
            </div>
            <div class="card-body">
              <% const records = healthRecords[pet.pet_id] || []; %>
              <% if (records.length === 0) { %>
                <div class="text-center py-4">
                  <i class="bi bi-clipboard-x display-4 text-muted"></i>
                  <p class="mt-3 text-muted">No health records found for <%= pet.name %></p>
                  <a href="/health-tracker/add?pet_id=<%= pet.pet_id %>" class="btn btn-outline-primary">
                    Add First Health Record
                  </a>
                </div>
              <% } else { %>
                <div class="table-responsive">
                  <table class="table table-striped table-hover">
                    <thead>
                      <tr>
                        <th>Date</th>
                        <th>Weight</th>
                        <th>Diet</th>
                        <th>Vet Visit</th>
                        <th>Vaccination</th>
                        <th>Next Vaccination</th>
                        <th>Actions</th>
                      </tr>
                    </thead>
                    <tbody>
                      <% records.forEach(record => { %>
                        <tr>
                          <td>
                            <strong><%= new Date(record.date_recorded).toLocaleDateString() %></strong>
                          </td>
                          <td>
                            <% if (record.weight) { %>
                              <%= record.weight %> kg
                            <% } else { %>
                              <span class="text-muted">-</span>
                            <% } %>
                          </td>
                          <td>
                            <% if (record.diet) { %>
                              <%= record.diet.substring(0, 30) %><%= record.diet.length > 30 ? '...' : '' %>
                            <% } else { %>
                              <span class="text-muted">-</span>
                            <% } %>
                          </td>
                          <td>
                            <% if (record.vet_visit_date) { %>
                              <%= new Date(record.vet_visit_date).toLocaleDateString() %>
                            <% } else { %>
                              <span class="text-muted">-</span>
                            <% } %>
                          </td>
                          <td>
                            <% if (record.vaccination_date) { %>
                              <%= new Date(record.vaccination_date).toLocaleDateString() %>
                            <% } else { %>
                              <span class="text-muted">-</span>
                            <% } %>
                          </td>
                          <td>
                            <% if (record.next_vaccination_date) { %>
                              <% const nextVaccDate = new Date(record.next_vaccination_date); %>
                              <% const today = new Date(); %>
                              <span class="<%= nextVaccDate < today ? 'text-danger' : '' %>">
                                <%= nextVaccDate.toLocaleDateString() %>
                                <% if (nextVaccDate < today) { %>
                                  <br><small class="text-danger">Overdue</small>
                                <% } %>
                              </span>
                            <% } else { %>
                              <span class="text-muted">-</span>
                            <% } %>
                          </td>
                          <td>
                            <div class="btn-group btn-group-sm">
                              <button class="btn btn-outline-primary view-record" 
                                      data-record-id="<%= record.health_id %>"
                                      title="View Details">
                                <i class="bi bi-eye"></i>
                              </button>
                              <button class="btn btn-outline-warning edit-record"
                                      data-record-id="<%= record.health_id %>"
                                      title="Edit Record">
                                <i class="bi bi-pencil"></i>
                              </button>
                              <button class="btn btn-outline-danger delete-record"
                                      data-record-id="<%= record.health_id %>"
                                      data-pet-name="<%= pet.name %>"
                                      data-record-date="<%= new Date(record.date_recorded).toLocaleDateString() %>"
                                      title="Delete Record">
                                <i class="bi bi-trash"></i>
                              </button>
                            </div>
                          </td>
                        </tr>
                      <% }); %>
                    </tbody>
                  </table>
                </div>
              <% } %>
            </div>
          </div>
        <% }); %>
      <% } %>
    </div>
  </div>
</div>

<!-- Record Details Modal -->
<div class="modal fade" id="recordModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Health Record Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="recordDetails">
        <!-- Content loaded via JavaScript -->
      </div>
    </div>
  </div>
</div>

<style>
  /* Mobile-specific spacing fixes for Health Tracker */
@media (max-width: 768px) {
  .container-fluid {
    padding-top: 5rem !important; /* Add space between header and content */
  }
  
  .d-flex.justify-content-between.align-items-center.mb-4 {
    margin-top: 5rem !important; /* Add space below navbar */
  }
  
  /* Remove top spacing from the main container */
  .container-fluid .row {
    margin-top: 0 !important;
  }
  
 
  /* Ensure cards don't have extra top spacing */
  .card {
    margin-top: 0 !important;
  }
  
  .card:first-child {
    margin-top: 0 !important;
  }
  
  /* Adjust card header padding for mobile */
  .card-header {
    padding: 0.75rem 0.5rem !important;
  }
  
  /* Adjust card body padding for mobile */
  .card-body {
    padding: 1rem 0.5rem !important;
  }
  
  /* Make the table more mobile-friendly */
  .table-responsive {
    margin: 0 -0.5rem !important;
  }
  
  /* Adjust button sizes for mobile */
  .btn-group-sm > .btn {
    padding: 0.25rem 0.5rem !important;
  }
  
  /* Ensure alert spacing is minimal */
  .alert {
    margin-top: 0.5rem !important;
    margin-bottom: 1rem !important;
  }
}

/* Additional aggressive spacing removal for very small screens */
@media (max-width: 480px) {
   .container-fluid {
    padding-top: 5rem !important;
  }
  
   .d-flex.justify-content-between.align-items-center.mb-4 {
    margin-top: 5rem !important; /* Add space below navbar */
  }
  /* Stack the header buttons on very small screens */
  .d-flex.justify-content-between.align-items-center {
    flex-direction: column !important;
    gap: 0.5rem !important;
    align-items: flex-start !important;
  }
  
  .d-flex.justify-content-between.align-items-center h1 {
    margin-bottom: 0 !important;
  }
  
  /* Make table more compact */
  .table td, .table th {
    padding: 0.5rem 0.25rem !important;
    font-size: 0.875rem !important;
  }
  
  /* Adjust button text for very small screens */
  .btn {
    font-size: 0.875rem !important;
    padding: 0.5rem 0.75rem !important;
  }
  
  /* Reduce card spacing */
  .card {
    margin-bottom: 1rem !important;
  }
}

/* Ensure no spacing from header partial */
.navbar {
  margin-bottom: 0 !important;
}

/* Remove any body spacing */
body {
  margin: 0 !important;
  padding: 0 !important;
}

/* Target direct children to remove spacing */
body > .container-fluid {
  margin-top: 0 !important;
  padding-top: 0 !important;
}



</style>

<script>
// View record details
document.querySelectorAll('.view-record').forEach(btn => {
  btn.addEventListener('click', async function() {
    const recordId = this.dataset.recordId;
    
    try {
      const response = await fetch(`/health/records/${recordId}`);
      const record = await response.json();
      
      if (response.ok) {
        document.getElementById('recordDetails').innerHTML = `
          <div class="row">
            <div class="col-md-6">
              <h6>Basic Information</h6>
              <p><strong>Pet:</strong> ${record.pet_name}</p>
              <p><strong>Record Date:</strong> ${new Date(record.date_recorded).toLocaleDateString()}</p>
              <p><strong>Weight:</strong> ${record.weight ? record.weight + ' kg' : 'Not recorded'}</p>
              <p><strong>Diet:</strong> ${record.diet || 'Not recorded'}</p>
            </div>
            <div class="col-md-6">
              <h6>Medical Information</h6>
              <p><strong>Vet Visit:</strong> ${record.vet_visit_date ? new Date(record.vet_visit_date).toLocaleDateString() : 'Not recorded'}</p>
              <p><strong>Vaccination:</strong> ${record.vaccination_date ? new Date(record.vaccination_date).toLocaleDateString() : 'Not recorded'}</p>
              <p><strong>Next Vaccination:</strong> ${record.next_vaccination_date ? new Date(record.next_vaccination_date).toLocaleDateString() : 'Not scheduled'}</p>
            </div>
          </div>
          ${record.medical_notes ? `
            <div class="row mt-3">
              <div class="col-12">
                <h6>Medical Notes</h6>
                <div class="border rounded p-3 bg-light">
                  ${record.medical_notes}
                </div>
              </div>
            </div>
          ` : ''}
        `;
        
        new bootstrap.Modal(document.getElementById('recordModal')).show();
      } else {
        alert('Error loading record details');
      }
    } catch (error) {
      // console.error('Error:', error);
      alert('Error loading record details');
    }
  });
});

// Edit record - ADD THIS FUNCTION
document.querySelectorAll('.edit-record').forEach(btn => {
  btn.addEventListener('click', function() {
    const recordId = this.dataset.recordId;
    // Redirect to edit page
    window.location.href = `/health/edit/${recordId}`;
  });
});

// Delete record
document.querySelectorAll('.delete-record').forEach(btn => {
  btn.addEventListener('click', function() {
    const recordId = this.dataset.recordId;
    const petName = this.dataset.petName;
    const recordDate = this.dataset.recordDate;
    
    if (confirm(`Are you sure you want to delete the health record for ${petName} from ${recordDate}?`)) {
      fetch(`/health/${recordId}`, {
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/json'
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.ok) {
          location.reload();
        } else {
          alert('Error deleting record: ' + data.error);
        }
      })
      .catch(error => {
        // console.error('Error:', error);
        alert('Error deleting record');
      });
    }
  });
});
</script>

<%- include('partials/footer') %>