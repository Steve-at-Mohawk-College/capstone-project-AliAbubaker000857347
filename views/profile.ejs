<%- include('partials/header', {title: 'My Profile - Pet Care' }) %>
  <style>
    /* ===== ENHANCED PROFESSIONAL PROFILE STYLES ===== */
    :root {
      --primary: #4361ee;
      --primary-light: #4895ef;
      --secondary: #06d6a0;
      --accent: #ff6b6b;
      --warning: #ffd166;
      --light: #f8f9fa;
      --dark: #212529;
      --gray: #6c757d;
      --light-gray: #e9ecef;
      --border-radius: 12px;
      --shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* Base Layout */
    .profile-container {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      min-height: 100vh;
      padding: 2rem 0;
    }

    .navbar-modern {
      position: relative !important;
      top: auto !important;
    }

    body {
      padding-top: 0 !important;
      margin: 0 !important;
      background: #f8f9fa;
    }

    /* Enhanced Cards */
    .card-custom {
      border: none;
      box-shadow: var(--shadow);
      border-radius: var(--border-radius);
      transition: var(--transition);
      background: white;
      border: 1px solid rgba(0, 0, 0, 0.05);
    }

    .card-custom:hover {
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
      transform: translateY(-2px);
    }

    /* Profile Header */
    .profile-header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      border-radius: var(--border-radius);
      padding: 2.5rem;
      margin-bottom: 2rem;
      color: white;
      position: relative;
      overflow: hidden;
    }

    .profile-header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
    }

    .profile-header-content {
      position: relative;
      z-index: 2;
    }

    /* Profile Picture Enhanced */
    .profile-picture-container {
      position: relative;
      display: inline-block;
      margin-bottom: 1.5rem;
    }

    .profile-picture {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      border: 4px solid rgba(255, 255, 255, 0.3);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
      transition: var(--transition);
      object-fit: cover;
    }

    .profile-picture:hover {
      transform: scale(1.05);
      border-color: rgba(255, 255, 255, 0.6);
    }

    .profile-picture-actions {
      position: absolute;
      bottom: 8px;
      right: 8px;
      display: flex;
      gap: 6px;
    }

    .profile-picture-btn {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: 2px solid white;
      display: flex;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(10px);
      transition: var(--transition);
      cursor: pointer;
      font-size: 0.9rem;
    }

    .profile-picture-btn.upload {
      background: rgba(67, 97, 238, 0.9);
      color: white;
    }

    .profile-picture-btn.remove {
      background: rgba(255, 107, 107, 0.9);
      color: white;
    }

    .profile-picture-btn:hover {
      transform: scale(1.1);
    }

    /* Stats Cards Enhanced */
    .stats-card {
      border-radius: var(--border-radius);
      border: none;
      color: white;
      position: relative;
      overflow: hidden;
      transition: var(--transition);
      height: 100%;
    }

    .stats-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0) 100%);
    }

    .stats-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
    }

    .stats-card .card-body {
      position: relative;
      z-index: 2;
      padding: 1.5rem;
    }

    .stats-icon {
      font-size: 2rem;
      opacity: 0.9;
      margin-bottom: 0.75rem;
    }

    /* Bio Section Enhanced */
    .bio-section {
      background: white;
    }

    .bio-textarea {
      border-radius: 8px;
      border: 2px solid #e9ecef;
      transition: var(--transition);
      resize: vertical;
      min-height: 120px;
      font-size: 0.9rem;
    }

    .bio-textarea:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 0.2rem rgba(67, 97, 238, 0.15);
    }

    .bio-preview {
      background: rgba(67, 97, 238, 0.03);
      border-radius: 8px;
      padding: 1.25rem;
      border-left: 4px solid var(--primary);
    }

    /* Settings Section */
    .settings-item {
      padding: 1.25rem 0;
      border-bottom: 1px solid rgba(0, 0, 0, 0.06);
      transition: var(--transition);
    }

    .settings-item:hover {
      background: rgba(67, 97, 238, 0.02);
    }

    .settings-item:last-child {
      border-bottom: none;
    }

    /* Email Status Styles */
    .email-status-container {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1rem;
    }

    .current-email-display {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.75rem;
      background: white;
      border-radius: 6px;
      border: 1px solid #e9ecef;
    }

    .pending-email-display {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.75rem;
      background: #fff3cd;
      border-radius: 6px;
      border: 1px solid #ffeaa7;
      margin-top: 0.5rem;
    }

    .email-info {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .email-actions {
      display: flex;
      gap: 0.5rem;
    }

    /* Badges */
    .badge-modern {
      padding: 0.4rem 0.8rem;
      border-radius: 20px;
      font-weight: 600;
      font-size: 0.75rem;
    }

    /* Buttons */
    .btn-modern {
      border-radius: 8px;
      padding: 0.6rem 1.25rem;
      font-weight: 500;
      transition: var(--transition);
      border: 2px solid transparent;
      font-size: 0.875rem;
    }

    .btn-modern-primary {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      border: none;
      color: white;
    }

    .btn-modern-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 15px rgba(67, 97, 238, 0.3);
    }

    .btn-modern-sm {
      padding: 0.4rem 0.8rem;
      font-size: 0.8rem;
    }

    /* Form Controls */
    .form-control-modern {
      border-radius: 8px;
      border: 2px solid #e9ecef;
      padding: 0.6rem 0.8rem;
      transition: var(--transition);
      font-size: 0.9rem;
    }

    .form-control-modern:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 0.2rem rgba(67, 97, 238, 0.15);
    }

    /* Quick Actions */
    .quick-action-card {
      border-radius: var(--border-radius);
      transition: var(--transition);
      border: 1px solid rgba(0, 0, 0, 0.05);
      text-decoration: none;
      color: inherit;
      height: 100%;
    }

    .quick-action-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
      text-decoration: none;
      color: inherit;
    }

    .quick-action-icon {
      font-size: 2rem;
      margin-bottom: 0.75rem;
      transition: var(--transition);
    }

    .quick-action-card:hover .quick-action-icon {
      transform: scale(1.1);
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .profile-container {
        padding: 1rem 0;
      }

      .profile-header {
        padding: 1.5rem;
        text-align: center;
      }

      .profile-picture {
        width: 100px;
        height: 100px;
      }

      .stats-card .h2 {
        font-size: 1.5rem;
      }

      .current-email-display,
      .pending-email-display {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
      }

      .email-actions {
        align-self: flex-end;
      }
    }

    /* Animation Classes */
    .fade-in {
      animation: fadeIn 0.6s ease-in-out;
    }

    .slide-up {
      animation: slideUp 0.6s ease-out;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Loading States */
    .loading {
      opacity: 0.7;
      pointer-events: none;
    }

    .loading::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 16px;
      height: 16px;
      border: 2px solid #f3f3f3;
      border-top: 2px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% {
        transform: translate(-50%, -50%) rotate(0deg);
      }

      100% {
        transform: translate(-50%, -50%) rotate(360deg);
      }
    }

    /* Professional spacing and typography */
    .card-header {
      padding: 1.25rem 1.5rem;
      background: transparent;
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    }

    .card-body {
      padding: 1.5rem;
    }

    .section-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--dark);
      margin-bottom: 1rem;
    }

    .form-label {
      font-weight: 500;
      color: var(--dark);
      margin-bottom: 0.5rem;
    }


    /* ===== DARK MODE SUPPORT ===== */
    [data-theme="dark"] .profile-container {
      background: linear-gradient(135deg, #1a1d23 0%, #212529 100%);
    }

    [data-theme="dark"] .card-custom {
      background: rgba(33, 37, 41, 0.95);
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: #e9ecef;
    }

    [data-theme="dark"] .bio-section {
      background: linear-gradient(135deg, #212529 0%, #1a1d23 100%);
    }

    [data-theme="dark"] .text-dark {
      color: #e9ecef !important;
    }

    [data-theme="dark"] .text-muted {
      color: #adb5bd !important;
    }

    [data-theme="dark"] .form-control-modern {
      background: #2d3035;
      border-color: #495057;
      color: #e9ecef;
    }

    [data-theme="dark"] .form-control-modern:focus {
      background: #2d3035;
      border-color: var(--primary);
      color: #e9ecef;
    }

    [data-theme="dark"] .bio-textarea {
      background: #2d3035;
      border-color: #495057;
      color: #e9ecef;
    }

    [data-theme="dark"] .bio-textarea:focus {
      background: #2d3035;
      border-color: var(--primary);
      color: #e9ecef;
    }

    [data-theme="dark"] .bio-preview {
      background: rgba(67, 97, 238, 0.1);
      border-left: 4px solid var(--primary);
      color: #e9ecef;
    }

    [data-theme="dark"] .alert-light {
      background: #2d3035;
      border-color: #495057;
      color: #e9ecef;
    }

    [data-theme="dark"] .btn-light {
      background: #495057;
      border-color: #6c757d;
      color: #e9ecef;
    }

    [data-theme="dark"] .btn-light:hover {
      background: #6c757d;
      border-color: #adb5bd;
      color: #ffffff;
    }

    [data-theme="dark"] .btn-outline-primary {
      color: var(--primary);
      border-color: var(--primary);
    }

    [data-theme="dark"] .btn-outline-primary:hover {
      background: var(--primary);
      border-color: var(--primary);
      color: white;
    }

    [data-theme="dark"] .btn-outline-secondary {
      color: #adb5bd;
      border-color: #6c757d;
    }

    [data-theme="dark"] .btn-outline-secondary:hover {
      background: #6c757d;
      border-color: #6c757d;
      color: white;
    }

    [data-theme="dark"] .btn-outline-danger {
      color: var(--accent);
      border-color: var(--accent);
    }

    [data-theme="dark"] .btn-outline-danger:hover {
      background: var(--accent);
      border-color: var(--accent);
      color: white;
    }

    [data-theme="dark"] .settings-item {
      border-bottom-color: rgba(255, 255, 255, 0.1);
    }

    [data-theme="dark"] .settings-item:hover {
      background: rgba(67, 97, 238, 0.05);
    }

    [data-theme="dark"] .quick-action-card {
      border-color: rgba(255, 255, 255, 0.1);
      background: rgba(33, 37, 41, 0.95);
    }

    [data-theme="dark"] .quick-action-card:hover {
      background: rgba(33, 37, 41, 1);
    }

    [data-theme="dark"] .form-label {
      color: #e9ecef;
    }

    [data-theme="dark"] .form-text {
      color: #adb5bd !important;
    }

    [data-theme="dark"] .border-top {
      border-top-color: rgba(255, 255, 255, 0.1) !important;
    }

    /* Ensure text colors are properly set for dark mode */
    [data-theme="dark"] .card-title,
    [data-theme="dark"] .h3,
    [data-theme="dark"] .h4,
    [data-theme="dark"] .h5,
    [data-theme="dark"] .h6,
    [data-theme="dark"] .fw-bold,
    [data-theme="dark"] .fw-semibold {
      color: #e9ecef !important;
    }

    [data-theme="dark"] .small {
      color: #adb5bd !important;
    }

    /* Fix the email display in dark mode */
    [data-theme="dark"] .alert-light strong {
      color: #e9ecef !important;
    }

    /* Fix the "Back to Dashboard" button text */
    [data-theme="dark"] .btn-light {
      color: #e9ecef !important;
    }

    /* Fix bio character count */
    [data-theme="dark"] #bioCharCount {
      color: #adb5bd !important;
    }

    /* Fix the bio approval info text */
    [data-theme="dark"] .text-muted small {
      color: #adb5bd !important;
    }


    /* ===== DARK MODE EMAIL STATUS FIXES ===== */
    [data-theme="dark"] .email-status-container {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    [data-theme="dark"] .current-email-display {
      background: rgba(33, 37, 41, 0.8);
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: #e9ecef;
    }

    [data-theme="dark"] .pending-email-display {
      background: rgba(255, 193, 7, 0.15);
      border: 1px solid rgba(255, 193, 7, 0.3);
      color: #ffd166;
    }

    [data-theme="dark"] .current-email-display strong,
    [data-theme="dark"] .pending-email-display strong {
      color: #ffffff !important;
    }

    [data-theme="dark"] .badge.bg-success {
      background: linear-gradient(135deg, #198754 0%, #20c997 100%) !important;
      color: white !important;
    }

    [data-theme="dark"] .badge.bg-warning {
      background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%) !important;
      color: #212529 !important;
    }

    [data-theme="dark"] .email-info .text-primary {
      color: #6ea8fe !important;
    }

    [data-theme="dark"] .email-info .text-warning {
      color: #ffd166 !important;
    }

    [data-theme="dark"] .form-text.small {
      color: #adb5bd !important;
    }

    /* Fix the email actions buttons in dark mode */
    [data-theme="dark"] .email-actions .btn-outline-secondary {
      color: #adb5bd;
      border-color: #6c757d;
    }

    [data-theme="dark"] .email-actions .btn-outline-secondary:hover {
      background: #6c757d;
      border-color: #adb5bd;
      color: white;
    }

    [data-theme="dark"] .email-actions .btn-outline-primary {
      color: #6ea8fe;
      border-color: #6ea8fe;
    }

    [data-theme="dark"] .email-actions .btn-outline-primary:hover {
      background: #6ea8fe;
      border-color: #6ea8fe;
      color: white;
    }

    /* ===== DARK MODE ACCOUNT DELETION FIXES ===== */
    [data-theme="dark"] .alert-info {
      background: rgba(13, 110, 253, 0.15) !important;
      border: 1px solid rgba(13, 110, 253, 0.3) !important;
      color: #e9ecef !important;
    }

    [data-theme="dark"] .alert-info .alert-heading {
      color: #6ea8fe !important;
    }

    [data-theme="dark"] .alert-info a {
      color: #6ea8fe !important;
    }

    [data-theme="dark"] .alert-info a:hover {
      color: #8bb9fe !important;
    }

    [data-theme="dark"] .bg-light {
      background: rgba(255, 255, 255, 0.05) !important;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    [data-theme="dark"] .bg-light .text-dark {
      color: #e9ecef !important;
    }

    [data-theme="dark"] .bg-light .text-muted {
      color: #adb5bd !important;
    }

    /* ===== DARK MODE MOBILE MENU FIX FOR PROFILE PAGE ===== */
    [data-theme="dark"] .navbar-collapse-modern {
      background: #1a1d21 !important;
      border-right: 1px solid #2d3239 !important;
    }

    [data-theme="dark"] .navbar-nav-modern {
      background: #1a1d21 !important;
    }

    [data-theme="dark"] .nav-link-modern {
      color: #e9ecef !important;
      border-bottom: 1px solid #2d3239 !important;
      background: #1a1d21 !important;
    }

    [data-theme="dark"] .nav-link-modern:hover,
    [data-theme="dark"] .nav-link-modern:focus {
      color: #6ea8fe !important;
      background-color: rgba(110, 168, 254, 0.1) !important;
    }

    [data-theme="dark"] .nav-link-modern.active {
      color: #6ea8fe !important;
      background-color: rgba(110, 168, 254, 0.15) !important;
      border-left: 4px solid #6ea8fe !important;
    }

    [data-theme="dark"] .navbar-collapse-modern .dropdown-menu {
      background: #1a1d21 !important;
      border: 1px solid #2d3239 !important;
    }

    [data-theme="dark"] .navbar-collapse-modern .dropdown-item {
      color: #e9ecef !important;
      background: #1a1d21 !important;
      border-bottom: 1px solid #2d3239 !important;
    }

    [data-theme="dark"] .navbar-collapse-modern .dropdown-item:hover {
      background-color: rgba(110, 168, 254, 0.1) !important;
      color: #6ea8fe !important;
    }

    /* Mobile header icons dark mode */
    [data-theme="dark"] .header-icons-mobile .profile-modern,
    [data-theme="dark"] .header-icons-mobile .theme-toggle-modern,
    [data-theme="dark"] .header-icons-mobile .notification-bell {
      background: rgba(67, 97, 238, 0.15) !important;
      border: 1px solid rgba(67, 97, 238, 0.3) !important;
      color: #e9ecef !important;
    }

    [data-theme="dark"] .header-icons-mobile .profile-modern:hover,
    [data-theme="dark"] .header-icons-mobile .theme-toggle-modern:hover,
    [data-theme="dark"] .header-icons-mobile .notification-bell:hover {
      background: rgba(67, 97, 238, 0.25) !important;
      color: #6ea8fe !important;
    }

    /* ===== DARK MODE SUPPORT ===== */
    [data-theme="dark"] .profile-container {
      background: linear-gradient(135deg, #1a1d23 0%, #212529 100%);
    }

    [data-theme="dark"] .card-custom {
      background: rgba(33, 37, 41, 0.95);
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: #e9ecef;
    }

    /* ===== DARK MODE HAMBURGER MENU ICON FIX ===== */
    [data-theme="dark"] .navbar-toggler-modern {
      background: rgba(0, 0, 0, 0.8) !important;
      border: 1px solid rgba(255, 255, 255, 0.3) !important;
    }

    [data-theme="dark"] .navbar-toggler-modern .navbar-toggler-icon,
    [data-theme="dark"] .navbar-toggler-modern .navbar-toggler-icon::before,
    [data-theme="dark"] .navbar-toggler-modern .navbar-toggler-icon::after {
      background-color: #ffffff !important;
    }

    [data-theme="dark"] .navbar-toggler-modern:hover {
      background: rgba(0, 0, 0, 0.9) !important;
      border-color: rgba(255, 255, 255, 0.5) !important;
    }

    [data-theme="dark"] .navbar-toggler-modern:focus {
      box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.25) !important;
      outline: none;
    }

    /* Fix mobile padding for very small screens */
    @media (max-width: 400px) {
      .profile-container {
        padding-left: 15px !important;
        padding-right: 15px !important;
      }

      .container-fluid.profile-container {
        padding-left: 15px !important;
        padding-right: 15px !important;
        margin-left: 0 !important;
        margin-right: 0 !important;
      }

      /* Ensure content inside has consistent padding */
      .card-custom {
        margin-left: 0 !important;
        margin-right: 0 !important;
        padding-left: 15px !important;
        padding-right: 15px !important;
      }

      /* Fix the row gutters on mobile */
      .row.g-4 {
        margin-left: -8px !important;
        margin-right: -8px !important;
      }

      .col-xxl-10 {
        padding-left: 8px !important;
        padding-right: 8px !important;
      }
    }

    @media (max-width: 300px) {
      .profile-container {
        padding-left: 15px !important;
        padding-right: 15px !important;
      }

      .container-fluid.profile-container {
        padding-left: 15px !important;
        padding-right: 15px !important;
        margin-left: 0 !important;
        margin-right: 0 !important;
      }

      /* Ensure content inside has consistent padding */
      .card-custom {
        margin-left: 0 !important;
        margin-right: 0 !important;
        padding-left: 15px !important;
        padding-right: 15px !important;
      }

      /* Fix the row gutters on mobile */
      .row.g-4 {
        margin-left: -8px !important;
        margin-right: -8px !important;
      }

      .col-xxl-10 {
        padding-left: 8px !important;
        padding-right: 8px !important;
      }
    }

    @media (max-width: 200px) {
      .profile-container {
        padding-left: 15px !important;
        padding-right: 15px !important;
      }

      .container-fluid.profile-container {
        padding-left: 15px !important;
        padding-right: 15px !important;
        margin-left: 0 !important;
        margin-right: 0 !important;
      }

      /* Ensure content inside has consistent padding */
      .card-custom {
        margin-left: 0 !important;
        margin-right: 0 !important;
        padding-left: 15px !important;
        padding-right: 15px !important;
      }

      /* Fix the row gutters on mobile */
      .row.g-4 {
        margin-left: -8px !important;
        margin-right: -8px !important;
      }

      .col-xxl-10 {
        padding-left: 8px !important;
        padding-right: 8px !important;
      }
    }
    /* Fix for ultra-small mobile screens (less than 360px) */
    @media (max-width: 359.98px) {

      /* Reset all container padding */
      body>.container-fluid.profile-container,
      .container-fluid.profile-container {
        padding-left: 8px !important;
        padding-right: 8px !important;
        margin-left: 0 !important;
        margin-right: 0 !important;
        overflow-x: hidden !important;
      }

      /* Fix the inner grid structure */
      .container-fluid.profile-container>.row.justify-content-center {
        margin-left: -8px !important;
        margin-right: -8px !important;
      }

      /* Fix the main content column */
      .col-xxl-10 {
        padding-left: 8px !important;
        padding-right: 8px !important;
        width: 100% !important;
        max-width: 100% !important;
      }

      /* Remove negative margins from rows */
      .row.g-4 {
        margin-left: -4px !important;
        margin-right: -4px !important;
      }

      /* Fix column padding for ultra-small screens */
      .row.g-4>div {
        padding-left: 4px !important;
        padding-right: 4px !important;
      }

      /* Fix profile header */
      .profile-header {
        margin-left: -8px !important;
        margin-right: -8px !important;
        padding: 1rem 12px !important;
        border-radius: 0 !important;
      }

      /* Reduce card padding */
      .card-custom {
        padding-left: 12px !important;
        padding-right: 12px !important;
        margin-left: 0 !important;
        margin-right: 0 !important;
      }

      .card-body {
        padding: 1rem !important;
      }

      /* Fix form elements */
      .form-control-modern,
      .bio-textarea {
        padding: 0.5rem 0.6rem !important;
        font-size: 0.85rem !important;
      }

      /* Reduce button padding */
      .btn-modern {
        padding: 0.5rem 0.8rem !important;
        font-size: 0.8rem !important;
      }

      /* Fix settings items layout */
      .settings-item .row.align-items-center {
        margin-left: -4px !important;
        margin-right: -4px !important;
      }

      .settings-item .col-md-4,
      .settings-item .col-md-8 {
        padding-left: 4px !important;
        padding-right: 4px !important;
      }

      /* Ensure all text fits */
      h1,
      h2,
      h3,
      h4,
      h5,
      h6 {
        font-size: 90% !important;
      }

      /* Fix email display */
      .current-email-display,
      .pending-email-display {
        flex-direction: column !important;
        align-items: flex-start !important;
        padding: 0.5rem !important;
      }

      .email-actions {
        align-self: flex-start !important;
        margin-top: 0.5rem !important;
      }

      /* Fix responsive text */
      .text-truncate {
        max-width: 100% !important;
      }

      /* Remove any min-width constraints */
      *[style*="min-width"] {
        min-width: auto !important;
      }
    }

    /* Fixed Profile Picture Viewer Styles */
    #profilePictureModal .modal-dialog {
      max-width: 90vw;
      margin: 0 auto;
    }

    #profilePictureModal .modal-content {
      background: rgba(0, 0, 0, 0.9) !important;
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      overflow: hidden;
    }

    #profilePictureModal .modal-header {
      padding: 0.75rem;
      position: absolute;
      top: 0;
      right: 0;
      z-index: 1;
      border: none;
    }

    #profilePictureModal .modal-body {
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 300px;
    }
    #profilePictureModal #modalProfilePicture:hover {
      transform: scale(1.02);
    }

    /* Make profile picture clickable with proper cursor */
    #profilePicture {
      cursor: pointer;
      transition: all 0.3s ease;
    }

    #profilePicture:hover {
      transform: scale(1.03);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }

    /* Smooth modal transitions */
    .modal.fade .modal-dialog {
      transition: transform 0.3s ease-out;
    }

    /* Prevent body scrolling when modal is open */
    body.modal-open {
      overflow: hidden;
      padding-right: 0 !important;
    }

    /* Fix for modal backdrop */
    .modal-backdrop {
      background-color: rgba(0, 0, 0, 0.8);
    }

    .modal-backdrop.fade {
      opacity: 0;
    }

    .modal-backdrop.show {
      opacity: 0.8;
    }

    /* Profile Picture Action Menu Styles */
    .profile-picture-wrapper {
      position: relative;
      display: inline-block;
    }

    .profile-picture-menu {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(10px);
      border-radius: var(--border-radius);
      padding: 0.5rem;
      min-width: 200px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.1);
      z-index: 1000;
      display: none;
      animation: fadeIn 0.2s ease;
    }

    .profile-picture-menu.show {
      display: block;
    }

    .profile-picture-menu::before {
      content: '';
      position: absolute;
      top: -6px;
      left: 50%;
      transform: translateX(-50%);
      border-left: 6px solid transparent;
      border-right: 6px solid transparent;
      border-bottom: 6px solid rgba(0, 0, 0, 0.85);
    }

    .menu-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      width: 100%;
      padding: 0.75rem 1rem;
      background: transparent;
      border: none;
      color: white;
      text-align: left;
      cursor: pointer;
      transition: all 0.2s ease;
      border-radius: 6px;
      font-size: 0.9rem;
      font-weight: 500;
    }

    .menu-item:hover {
      background: rgba(255, 255, 255, 0.1);
      transform: translateX(3px);
    }

    .menu-item i {
      font-size: 1rem;
      width: 20px;
      text-align: center;
    }

    .menu-item.text-danger {
      color: #ff6b6b;
    }

    .menu-item.text-danger:hover {
      background: rgba(255, 107, 107, 0.1);
    }

    /* Dark mode support for menu */
    [data-theme="dark"] .profile-picture-menu {
      background: rgba(33, 37, 41, 0.95);
      border: 1px solid rgba(255, 255, 255, 0.15);
    }

    [data-theme="dark"] .profile-picture-menu::before {
      border-bottom-color: rgba(33, 37, 41, 0.95);
    }
    /* Modal backdrop - make it darker */
    .modal-backdrop.show {
      opacity: 0.9 !important;
      background-color: #000 !important;
    }

    /* Full-screen modal styling */
    #profilePictureModal .modal-dialog {
      max-width: 95vw;
      max-height: 95vh;
      margin: 10px auto;
    }

    #profilePictureModal .modal-content {
      background: transparent !important;
      border: none;
      box-shadow: none;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #profilePictureModal .modal-body {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      overflow: hidden;
    }
    #profilePictureModal #modalProfilePicture:hover {
      transform: scale(1.01);
    }

    /* Close button styling */
    #profilePictureModal .modal-header {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 10;
      border: none;
      padding: 0;
    }

    #profilePictureModal .btn-close {
      background: rgba(0, 0, 0, 0.7);
      border-radius: 50%;
      padding: 10px;
      opacity: 0.8;
      transition: all 0.3s ease;
      background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' fill='%23fff'%3e%3cpath d='M.293.293a1 1 0 0 1 1.414 0L8 6.586 14.293.293a1 1 0 1 1 1.414 1.414L9.414 8l6.293 6.293a1 1 0 0 1-1.414 1.414L8 9.414l-6.293 6.293a1 1 0 0 1-1.414-1.414L6.586 8 .293 1.707a1 1 0 0 1 0-1.414z'/%3e%3c/svg%3e");
    }

    #profilePictureModal .btn-close:hover {
      opacity: 1;
      transform: scale(1.1);
      background: rgba(0, 0, 0, 0.9);
    }
    /* Modal animation */
    .modal.fade .modal-dialog {
      transform: scale(0.9);
      transition: transform 0.3s ease-out;
    }
    .modal.show .modal-dialog {
      transform: scale(1);
    }
    #profilePicture:hover {
      transform: scale(1.05);
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
    }

    /* Ensure modal takes full viewport height */
    #profilePictureModal .modal-dialog-centered {
      min-height: calc(100vh - 20px);
    }
    /* Fix for modal zoom functionality */
    #profilePictureModal .modal-body {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      overflow: visible !important;
      min-height: 100vh;
    }

    #profilePictureModal .modal-content {
      background: transparent !important;
      border: none;
      box-shadow: none;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: visible !important;
    }
    /* Zoomed state */
    #profilePictureModal #modalProfilePicture.zoomed {
      transform: scale(2);
      cursor: zoom-out;
      position: relative;
      z-index: 1051;
    }

    /* Modal backdrop when zoomed */
    body.modal-open #profilePictureModal.zoomed~.modal-backdrop {
      background-color: rgba(0, 0, 0, 0.95) !important;
      backdrop-filter: blur(5px);
    }

    /* Modal dialog when zoomed */
    #profilePictureModal.zoomed .modal-dialog {
      transform: none !important;
      max-width: none !important;
      max-height: none !important;
      margin: 0 !important;
      width: 100vw !important;
      height: 100vh !important;
    }

    /* Modal content when zoomed */
    #profilePictureModal.zoomed .modal-content {
      background: rgba(0, 0, 0, 0.9) !important;
      width: 100% !important;
      height: 100% !important;
      align-items: center;
      justify-content: center;
    }

    /* Modal body when zoomed */
    #profilePictureModal.zoomed .modal-body {
      overflow: visible !important;
      width: 100% !important;
      height: 100% !important;
    }

    /* Add zoom controls */
    .zoom-controls {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1060;
      display: flex;
      gap: 10px;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    #profilePictureModal:hover .zoom-controls {
      opacity: 1;
    }

    .zoom-controls button {
      background: rgba(0, 0, 0, 0.7);
      border: 2px solid rgba(255, 255, 255, 0.3);
      color: white;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .zoom-controls button:hover {
      background: rgba(0, 0, 0, 0.9);
      border-color: rgba(255, 255, 255, 0.7);
      transform: scale(1.1);
    }

    /* Prevent body scroll when zoomed */
    body.zoom-mode {
      overflow: hidden !important;
      position: fixed;
      width: 100%;
      height: 100%;
    }

    /* Profile picture hover effect - FIXED */
    #profilePicture {
      cursor: pointer;
      transition: all 0.3s ease;
    }

    #profilePicture:hover {
      transform: scale(1.05);
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
    }

    /* Image container for zoom - FIXED */
    #profilePictureModal #modalProfilePicture {
      max-width: 90vw;
      max-height: 90vh;
      width: auto;
      height: auto;
      object-fit: contain;
      border-radius: 8px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      cursor: pointer;
      transition: transform 0.3s ease;
      transform-origin: center center;
    }

    /* Keep the zoom-in cursor only when image is zoomed out */
    #profilePictureModal #modalProfilePicture:not(.zoomed) {
      cursor: pointer;
    }

    /* Zoomed state - show grab cursor */
    #profilePictureModal #modalProfilePicture.zoomed {
      transform: scale(2);
      cursor: grab;
      position: relative;
      z-index: 1051;
    }

    /* When actively dragging */
    #profilePictureModal #modalProfilePicture.zoomed:active {
      cursor: grabbing;
    }

    #profilePictureModal #modalProfilePicture:hover {
      transform: scale(1.01);
    }
    @media (max-width: 768px) {
      #profilePictureModal .modal-dialog {
        max-width: 100vw !important;
        max-height: 100vh !important;
        margin: 0 !important;
        padding: 10px !important;
      }

      #profilePictureModal .modal-content {
        min-height: 100vh !important;
        max-height: 100vh !important;
        overflow: hidden !important;
      }

      #profilePictureModal .modal-body {
        min-height: calc(100vh - 100px) !important;
        max-height: calc(100vh - 100px) !important;
        overflow: auto !important;
        touch-action: pan-x pan-y !important;
      }

      #profilePictureModal #modalProfilePicture {
        max-width: 100% !important;
        max-height: 80vh !important;
        touch-action: pan-x pan-y !important;
      }

      /* Zoomed state on mobile */
      #profilePictureModal.zoomed .modal-body {
        overflow: auto !important;
        -webkit-overflow-scrolling: touch !important;
      }

      #profilePictureModal.zoomed #modalProfilePicture {
        max-width: none !important;
        max-height: none !important;
        min-height: 100% !important;
      }

      /* Fix zoom controls on mobile */
      .zoom-controls {
        bottom: 70px !important;
        /* Move up to avoid mobile browser UI */
        background: rgba(0, 0, 0, 0.7);
        padding: 10px;
        border-radius: 25px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
      }

      .zoom-controls button {
        width: 50px !important;
        height: 50px !important;
        font-size: 20px !important;
      }

      /* Always show zoom controls on mobile */
      #profilePictureModal .zoom-controls {
        opacity: 1 !important;
      }
    }

    /* Mobile touch improvements */
    @media (max-width: 576px) {
      #profilePictureModal .modal-dialog {
        width: 100vw !important;
        height: 100vh !important;
      }

      #profilePictureModal .modal-content {
        border-radius: 0 !important;
      }

      .zoom-controls {
        bottom: 20px !important;
        left: 50% !important;
        transform: translateX(-50%) !important;
        flex-wrap: wrap;
        justify-content: center;
        width: auto !important;
        max-width: 90vw !important;
      }

      .zoom-controls button {
        margin: 5px !important;
      }

      /* Double-tap to zoom */
      #profilePictureModal #modalProfilePicture {
        -webkit-tap-highlight-color: transparent;
      }
    }

    /* Prevent excessive zoom on mobile */
    @media (max-width: 768px) {
      #profilePictureModal.zoomed #modalProfilePicture {
        transform-origin: center center !important;
      }

      /* Add a visual indicator when zoomed */
      #profilePictureModal.zoomed::after {
        content: 'Pinch to zoom out â€¢ Double tap to reset';
        position: absolute;
        top: 60px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 12px;
        z-index: 1060;
        animation: fadeInOut 3s ease-in-out;
      }

      @keyframes fadeInOut {

        0%,
        100% {
          opacity: 0;
        }

        10%,
        90% {
          opacity: 1;
        }
      }
    }

    /* Mobile reset button */
    #mobileResetZoom {
      display: none;
      animation: fadeIn 0.3s ease;
    }

    #mobileResetZoom:hover {
      background: rgba(0, 0, 0, 0.9) !important;
      transform: scale(1.05);
    }

    /* Mobile gesture hints */
    .gesture-hint {
      position: fixed;
      bottom: 120px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 12px;
      z-index: 1060;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      text-align: center;
      max-width: 80%;
      white-space: nowrap;
    }

    /* Limit maximum zoom on mobile */
    @media (max-width: 768px) {
      #profilePictureModal #modalProfilePicture {
        max-width: 100vw !important;
      }

      #profilePictureModal.zoomed #modalProfilePicture {
        max-width: 300vw !important;
        /* Allow zoom but not excessive */
      }
    }
  </style>

  <div class="container-fluid profile-container">
    <div class="row justify-content-center">
      <div class="col-xxl-10">
        <!-- Professional Header Section -->
        <div class="profile-header slide-up">
          <div class="profile-header-content">
            <div class="row align-items-center">
              <div class="col-lg-8">
                <h1 class="h3 mb-2 fw-bold">Account Profile</h1>
                <p class="mb-0 opacity-90">Manage your personal information and account settings</p>
              </div>
              <div class="col-lg-4 text-lg-end mt-3 mt-lg-0">
                <a href="/dashboard" class="btn btn-light btn-modern">
                  <i class="bi bi-arrow-left me-2"></i>Back to Dashboard
                </a>
              </div>
            </div>
          </div>
        </div>

        <!-- Alerts -->
        <% if (typeof message !=='undefined' && message) { %>
          <div class="alert alert-info alert-dismissible fade show mb-4 fade-in">
            <i class="bi bi-info-circle me-2"></i>
            <%= message %>
              <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          </div>
          <% } %>

            <% if (typeof error !=='undefined' && error) { %>
              <div class="alert alert-danger alert-dismissible fade show mb-4 fade-in">
                <i class="bi bi-exclamation-triangle me-2"></i>
                <%= error %>
                  <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
              </div>
              <% } %>

                <div class="row g-4">
                  <!-- Left Column - Profile Overview -->
                  <div class="col-lg-4">
                    <!-- Profile Summary Card -->
                    <div class="card card-custom h-100 slide-up">
                      <div class="card-body text-center p-4">
                        <!-- Profile Picture -->
                        <!-- Profile Picture with Action Menu -->
                        <div class="profile-picture-container">
                          <div class="profile-picture-wrapper" id="profilePictureWrapper">
                            <img id="profilePicture"
                              src="<%= user.profile_picture_url || '/images/default-avatar.png' %>"
                              class="profile-picture" onerror="this.onerror=null; this.src='/images/default-avatar.png'"
                              alt="Profile Picture" crossorigin="anonymous">

                            <!-- Hidden Action Menu -->
                            <div class="profile-picture-menu" id="profilePictureMenu">
                              <button class="menu-item" onclick="viewProfilePicture()">
                                <i class="bi bi-eye"></i>
                                <span>See Profile Picture</span>
                              </button>
                              <button class="menu-item" onclick="openFileInput()">
                                <i class="bi bi-upload"></i>
                                <span>Update Profile Image</span>
                              </button>
                              <% if (user.profile_picture_url) { %>
                                <button class="menu-item text-danger" onclick="removeProfilePicture()">
                                  <i class="bi bi-trash"></i>
                                  <span>Remove Photo</span>
                                </button>
                                <% } %>
                            </div>
                          </div>
                          <!-- Keep the existing camera/trash icons for quick access -->
                          <div class="profile-picture-actions">
                            <label for="profilePictureInput" class="profile-picture-btn upload" title="Upload photo">
                              <i class="bi bi-camera-fill"></i>
                            </label>
                            <% if (user.profile_picture_url) { %>
                              <button class="profile-picture-btn remove" onclick="removeProfilePicture()"
                                title="Remove photo">
                                <i class="bi bi-trash"></i>
                              </button>
                              <% } %>
                          </div>
                        </div>

                        <!-- User Info -->
                        <h3 class="h5 mb-2 fw-bold text-dark">
                          <%= user.username %>
                        </h3>
                        <p class="text-muted mb-3 small">
                          <i class="bi bi-envelope me-1"></i>
                          <%= user.email %>
                        </p>

                        <!-- Account Type -->
                        <div class="mb-3">
                          <span class="badge-modern bg-<%= user.role === 'admin' ? 'danger' : 'primary' %> text-white">
                            <i class="bi bi-<%= user.role === 'admin' ? 'shield-shaded' : 'person' %> me-1"></i>
                            <%= user.role.charAt(0).toUpperCase() + user.role.slice(1) %> User
                          </span>
                        </div>

                        <!-- Member Since -->
                        <div class="text-muted small mb-3">
                          <i class="bi bi-calendar-event me-1"></i>
                          Joined <%= new Date(user.created_at).toLocaleDateString('en-US', { year: 'numeric' ,
                            month: 'long' , day: 'numeric' }) %>
                        </div>

                        <!-- Quick Stats -->
                        <div class="mt-3 pt-3 border-top">
                          <div class="row text-center">
                            <div class="col-6">
                              <div class="h6 mb-1 fw-bold text-primary">
                                <%= user.pet_count || 0 %>
                              </div>
                              <small class="text-muted">Pets</small>
                            </div>
                            <div class="col-6">
                              <div class="h6 mb-1 fw-bold text-warning">
                                <%= user.upcoming_task_count || 0 %>
                              </div>
                              <small class="text-muted">Active Tasks</small>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Right Column - Main Content -->
                  <div class="col-lg-8">
                    <!-- Stats Overview -->
                    <div class="row g-3 mb-4">
                      <div class="col-md-4">
                        <div class="card stats-card bg-primary slide-up" style="animation-delay: 0.1s;">
                          <div class="card-body text-center">
                            <div class="stats-icon">
                              <i class="bi bi-heart-pulse"></i>
                            </div>
                            <h4 class="h3 mb-1 fw-bold">
                              <%= user.pet_count || 0 %>
                            </h4>
                            <p class="mb-0 small opacity-90">Registered Pets</p>
                          </div>
                        </div>
                      </div>
                      <div class="col-md-4">
                        <div class="card stats-card bg-warning slide-up" style="animation-delay: 0.2s;">
                          <div class="card-body text-center">
                            <div class="stats-icon">
                              <i class="bi bi-calendar-check"></i>
                            </div>
                            <h4 class="h3 mb-1 fw-bold">
                              <%= user.upcoming_task_count || 0 %>
                            </h4>
                            <p class="mb-0 small opacity-90">Upcoming Tasks</p>
                          </div>
                        </div>
                      </div>
                      <div class="col-md-4">
                        <div class="card stats-card bg-success slide-up" style="animation-delay: 0.3s;">
                          <div class="card-body text-center">
                            <div class="stats-icon">
                              <i class="bi bi-clock-history"></i>
                            </div>
                            <h4 class="h3 mb-1 fw-bold">
                              <%= Math.floor((new Date() - new Date(user.created_at)) / (1000 * 60 * 60 * 24)) %>
                            </h4>
                            <p class="mb-0 small opacity-90">Days Active</p>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Personal Information Section -->
                    <div class="card card-custom slide-up" style="animation-delay: 0.4s;">
                      <div class="card-header">
                        <h5 class="card-title mb-0 d-flex align-items-center">
                          <i class="bi bi-person-gear text-primary me-2"></i>
                          Personal Information
                        </h5>
                      </div>
                      <div class="card-body">
                        <!-- Username Update -->
                        <div class="settings-item">
                          <div class="row align-items-center">
                            <div class="col-md-4">
                              <label class="form-label fw-semibold text-dark mb-1">Username</label>
                              <p class="text-muted mb-0 small">Your public display name</p>
                            </div>
                            <div class="col-md-8">
                              <form id="usernameForm" class="d-flex gap-2 align-items-start">
                                <div class="flex-grow-1">
                                  <input type="text" class="form-control form-control-modern" id="usernameInput"
                                    value="<%= user.username %>" required minlength="3"
                                    placeholder="Enter new username">
                                  <div class="form-text small">Minimum 3 characters</div>
                                </div>
                                <button type="submit" class="btn btn-primary btn-modern" id="updateUsernameBtn">
                                  <i class="bi bi-check-lg"></i>
                                </button>
                              </form>
                            </div>
                          </div>
                        </div>

                        <!-- Email Management -->
                        <div class="settings-item">
                          <div class="row">
                            <div class="col-12">
                              <label class="form-label fw-semibold text-dark mb-3">Email Address</label>

                              <!-- Current Email Display -->
                              <div class="email-status-container">
                                <div class="current-email-display">
                                  <div class="email-info">
                                    <i class="bi bi-envelope text-primary"></i>
                                    <div>
                                      <strong>
                                        <%= user.email %>
                                      </strong>
                                      <div class="d-flex align-items-center gap-2 mt-1">
                                        <% if (user.is_verified) { %>
                                          <span class="badge bg-success">
                                            <i class="bi bi-check-lg me-1"></i>Verified
                                          </span>
                                          <% } else { %>
                                            <span class="badge bg-warning">
                                              <i class="bi bi-clock me-1"></i>Unverified
                                            </span>
                                            <button class="btn btn-outline-primary btn-sm"
                                              onclick="resendVerification()">
                                              Resend Verification
                                            </button>
                                            <% } %>
                                      </div>
                                    </div>
                                  </div>
                                </div>

                                <!-- Pending Email Display (if any) -->
                                <div id="pendingEmailContainer" style="display: none;">
                                  <div class="pending-email-display">
                                    <div class="email-info">
                                      <i class="bi bi-clock text-warning"></i>
                                      <div>
                                        <strong id="pendingEmailText"></strong>
                                        <div class="small text-muted mt-1">Pending verification - check your email</div>
                                      </div>
                                    </div>
                                    <div class="email-actions">
                                      <button class="btn btn-outline-secondary btn-sm" onclick="cancelPendingEmail()">
                                        Cancel
                                      </button>
                                    </div>
                                  </div>
                                </div>
                              </div>

                              <!-- Email Update Form -->
                              <form id="emailForm" class="mt-3">
                                <div class="row g-2">
                                  <div class="col-md-8">
                                    <input type="email" class="form-control form-control-modern" id="emailInput"
                                      placeholder="Enter new email address" required>
                                    <div class="form-text small">
                                      We'll send a verification link to your new email address
                                    </div>
                                  </div>
                                  <div class="col-md-4">
                                    <button type="submit" class="btn btn-primary btn-modern w-100" id="updateEmailBtn">
                                      Update Email
                                    </button>
                                  </div>
                                </div>
                              </form>
                            </div>
                          </div>
                        </div>

                        <!-- Profile Picture Settings -->
                        <div class="settings-item">
                          <div class="row align-items-center">
                            <div class="col-md-4">
                              <label class="form-label fw-semibold text-dark mb-1">Profile Picture</label>
                              <p class="text-muted mb-0 small">Your profile image</p>
                            </div>
                            <div class="col-md-8">
                              <div class="d-flex gap-2 justify-content-end">
                                <label for="profilePictureInput" class="btn btn-outline-primary btn-modern">
                                  <i class="bi bi-upload me-2"></i>Upload Photo
                                </label>
                                <% if (user.profile_picture_url) { %>
                                  <button class="btn btn-outline-danger btn-modern" onclick="removeProfilePicture()">
                                    <i class="bi bi-trash me-2"></i>Remove
                                  </button>
                                  <% } %>
                              </div>
                              <div class="form-text text-end small">JPG, PNG up to 5MB</div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>


                    <!-- Bio Section -->
                    <div class="card card-custom mt-4 slide-up" style="animation-delay: 0.5s;">
                      <div class="card-header">
                        <h5 class="card-title mb-0 d-flex align-items-center">
                          <i class="bi bi-person-lines-fill text-primary me-2"></i>
                          About Me
                          <% if (user.bio && !user.bio_requires_moderation) { %>
                            <span class="badge-modern bg-success ms-2">
                              <i class="bi bi-check-lg me-1"></i>Approved
                            </span>
                            <% } %>
                        </h5>
                      </div>
                      <div class="card-body">
                        <!-- Bio moderation status -->
                        <% if (user.bio_requires_moderation) { %>
                          <div class="alert alert-warning d-flex align-items-center mb-4">
                            <i class="bi bi-clock-history me-2"></i>
                            <div>
                              <strong>Pending Approval</strong>
                              <div class="small">Your bio will be visible once approved by an administrator.</div>
                            </div>
                          </div>
                          <% } %>

                            <form id="bioForm">
                              <div class="row">
                                <div class="col-lg-8">
                                  <div class="mb-3">
                                    <label class="form-label fw-semibold text-dark">Tell us about yourself and your
                                      pets</label>
                                    <textarea class="form-control bio-textarea" id="bioInput" rows="4"
                                      placeholder="Share your story, your pets' personalities, or your experience with pet care..."><%= user.bio || '' %></textarea>
                                    <div class="form-text text-end">
                                      <span id="bioCharCount">0</span>/500 characters
                                    </div>
                                  </div>
                                </div>
                                <div class="col-lg-4">
                                  <div class="d-grid gap-2">
                                    <button type="submit" class="btn btn-modern btn-modern-primary" id="updateBioBtn">
                                      <i class="bi bi-check-lg me-2"></i>Update Bio
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" id="cancelBioBtn"
                                      style="display: none;">
                                      Cancel
                                    </button>
                                  </div>
                                  <div class="mt-3 text-center">
                                    <small class="text-muted">
                                      <i class="bi bi-info-circle me-1"></i>
                                      <% if (user.role==='regular' ) { %>
                                        Bio requires admin approval
                                        <% } else { %>
                                          Instant visibility for admins
                                          <% } %>
                                    </small>
                                  </div>
                                </div>
                              </div>
                            </form>

                            <!-- Current Bio Display -->
                            <% if (user.bio && !user.bio_requires_moderation) { %>
                              <div class="bio-preview mt-4 fade-in">
                                <h6 class="fw-semibold mb-2 text-dark">Current Bio:</h6>
                                <p class="mb-0 text-dark" style="white-space: pre-wrap; line-height: 1.6;">
                                  <%= user.bio %>
                                </p>
                              </div>
                              <% } %>
                      </div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="card card-custom mt-4 slide-up" style="animation-delay: 0.6s;">
                      <div class="card-header">
                        <h5 class="card-title mb-0 d-flex align-items-center">
                          <i class="bi bi-lightning-fill text-warning me-2"></i>
                          Quick Actions
                        </h5>
                      </div>
                      <div class="card-body">
                        <div class="row g-3">
                          <div class="col-md-6">
                            <a href="/pets/add" class="card quick-action-card text-decoration-none">
                              <div class="card-body text-center p-3">
                                <div class="quick-action-icon text-success">
                                  <i class="bi bi-plus-circle"></i>
                                </div>
                                <h6 class="card-title fw-bold text-dark mb-1">Add New Pet</h6>
                                <p class="text-muted small mb-0">Register a new pet to your account</p>
                              </div>
                            </a>
                          </div>
                          <div class="col-md-6">
                            <a href="/schedule-task" class="card quick-action-card text-decoration-none">
                              <div class="card-body text-center p-3">
                                <div class="quick-action-icon text-primary">
                                  <i class="bi bi-calendar-plus"></i>
                                </div>
                                <h6 class="card-title fw-bold text-dark mb-1">Schedule Task</h6>
                                <p class="text-muted small mb-0">Create reminders and tasks</p>
                              </div>
                            </a>
                          </div>
                        </div>
                      </div>
                    </div>


                    <!-- Account Deletion Information -->
                    <div class="card card-custom mt-4 slide-up" style="animation-delay: 0.7s;">
                      <div class="card-header">
                        <h5 class="card-title mb-0 d-flex align-items-center">
                          <i class="bi bi-shield-exclamation text-danger me-2"></i>
                          Account Security
                        </h5>
                      </div>
                      <div class="card-body">
                        <div class="alert alert-info border-0">
                          <div class="d-flex align-items-start">
                            <i class="bi bi-info-circle-fill text-primary me-3 fs-5 mt-1"></i>
                            <div>
                              <h6 class="alert-heading mb-2 fw-semibold">Account Deletion Policy</h6>
                              <p class="mb-2">For security reasons, users cannot delete their accounts directly. If you
                                need to delete your account, please contact our support team.</p>
                              <div class="d-flex align-items-center mt-3">
                                <i class="bi bi-envelope-fill text-primary me-2"></i>
                                <strong>Email:</strong>
                                <a href="mailto:support@petcare.com"
                                  class="ms-2 text-decoration-none">support@petcare.com</a>
                              </div>
                              <div class="mt-2 small text-muted">
                                Please include your username and reason for account deletion in your email.
                              </div>
                            </div>
                          </div>
                        </div>

                        <!-- Additional Security Information -->
                        <div class="row mt-3">
                          <div class="col-md-6">
                            <div class="d-flex align-items-center p-3 bg-light rounded">
                              <i class="bi bi-clock-history text-warning me-3 fs-4"></i>
                              <div>
                                <small class="text-muted d-block">Response Time</small>
                                <strong class="text-dark">Within 24-48 hours</strong>
                              </div>
                            </div>
                          </div>
                          <div class="col-md-6">
                            <div class="d-flex align-items-center p-3 bg-light rounded">
                              <i class="bi bi-shield-check text-success me-3 fs-4"></i>
                              <div>
                                <small class="text-muted d-block">Data Protection</small>
                                <strong class="text-dark">GDPR Compliant</strong>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
      </div>
    </div>
    <!-- Profile Picture Viewer Modal -->
    <div class="modal fade" id="profilePictureModal" tabindex="-1" role="dialog" aria-modal="true">
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content bg-dark border-0">
          <div class="modal-header border-0 pb-0">
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body text-center p-1">
            <img id="modalProfilePicture" src="" alt="Profile Picture" class="img-fluid rounded shadow-lg"
              style="max-height: 75vh; object-fit: contain;" crossorigin="anonymous" referrerpolicy="no-referrer">
          </div>

          <div class="zoom-controls">
            <button id="zoomInBtn" title="Zoom In">
              <i class="bi bi-zoom-in"></i>
            </button>
            <button id="zoomOutBtn" title="Zoom Out" disabled>
              <i class="bi bi-zoom-out"></i>
            </button>
            <button id="resetZoomBtn" title="Reset Zoom" disabled>
              <i class="bi bi-arrow-counterclockwise"></i>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- Hidden File Input -->
  <input type="file" id="profilePictureInput" accept="image/*" style="display: none;">

  <script>
    // Enhanced profile picture handling
    let isUploading = false;

    // Enhanced Profile Picture Upload Function
    async function uploadProfilePicture(file) {
      if (!file) {
        // console.log('No file provided');
        return;
      }
      if (isUploading) {
        // console.log('âš ï¸ Upload already in progress, skipping...');
        return;
      }

      // Validate file size (5MB)
      if (file.size > 5 * 1024 * 1024) {
        showAlert('File size must be less than 5MB', 'danger');
        return;
      }

      // console.log('Starting upload for:', file.name);

      // Show loading state
      const profileImg = document.getElementById('profilePicture');
      const uploadButton = document.querySelector('label[for="profilePictureInput"]');
      const originalSrc = profileImg.src;

      profileImg.style.opacity = '0.5';
      profileImg.style.filter = 'grayscale(50%)';

      if (uploadButton) {
        uploadButton.style.pointerEvents = 'none';
        uploadButton.style.opacity = '0.6';
      }

      isUploading = true;

      const formData = new FormData();
      formData.append('profilePicture', file);

      try {
        // console.log('Uploading to /profile/picture...');

        const response = await fetch('/profile/picture', {
          method: 'POST',
          body: formData,
          headers: {
            'Cache-Control': 'no-cache'
          }
        });

        // console.log('Response received:', response.status);

        const result = await response.json();
        // console.log('Upload response:', result);

        if (result.success) {
          // console.log('âœ… Upload successful');

          // Create new image URL with cache busting
          const timestamp = Date.now();
          const newImageUrl = result.profilePicture.split('?')[0] + '?t=' + timestamp;

          // console.log('ðŸ”„ Setting new image URL:', newImageUrl);

          // Update the profile picture immediately
          profileImg.src = newImageUrl;

          // Update all other profile pictures on the page
          updateAllProfilePictures(newImageUrl);

          showAlert('Profile picture updated successfully!', 'success');

        } else {
          // console.error('âŒ Upload failed:', result.error);
          showAlert(result.error || 'Error uploading picture', 'danger');
          // Restore original image on error
          profileImg.src = originalSrc;
        }
      } catch (error) {
        // console.error('âŒ Upload error:', error);
        showAlert('Error uploading profile picture: ' + error.message, 'danger');
        // Restore original image on error
        profileImg.src = originalSrc;
      } finally {
        // Reset UI states
        profileImg.style.opacity = '1';
        profileImg.style.filter = 'none';

        if (uploadButton) {
          uploadButton.style.pointerEvents = 'auto';
          uploadButton.style.opacity = '1';
        }
        // Reset file input
        document.getElementById('profilePictureInput').value = '';
        // Reset upload flag
        isUploading = false;
        // console.log('File input reset and upload completed');
      }
    }

    function fixModalAccessibility() {
      const modal = document.getElementById('profilePictureModal');
      if (!modal) return;
      modal.addEventListener('show.bs.modal', function () {
        this.setAttribute('aria-hidden', 'false');
        this.setAttribute('aria-modal', 'true');
      });

      modal.addEventListener('hide.bs.modal', function () {
        this.setAttribute('aria-hidden', 'true');
        this.removeAttribute('aria-modal');
      });

      // Ensure proper focus management
      modal.addEventListener('shown.bs.modal', function () {
        const closeBtn = this.querySelector('.btn-close');
        if (closeBtn) {
          closeBtn.focus();
        }
      });

      modal.addEventListener('hidden.bs.modal', function () {
        const closeBtn = this.querySelector('.btn-close');
        if (closeBtn) {
          closeBtn.blur();
        }
      });
    }

    // Enhanced function to update all profile pictures
    function updateAllProfilePictures(url) {
      // console.log('ðŸ”„ Updating all profile pictures with:', url);

      // Update main profile picture
      const mainProfileImg = document.getElementById('profilePicture');
      if (mainProfileImg) {
        mainProfileImg.src = url;
      }

      // Update header images with cache busting
      const headerImages = document.querySelectorAll('.user-avatar-modern, .navbar img, img[alt*="Profile"], img[src*="profile"]');
      headerImages.forEach(img => {
        if (img.tagName === 'IMG' && img !== mainProfileImg) {
          img.src = url;
          // console.log('âœ… Updated header image');
        }
      });
    }

    // Remove Profile Picture Function
    async function removeProfilePicture() {
      if (!confirm('Are you sure you want to remove your profile picture?')) {
        return;
      }

      // console.log('Removing profile picture...');

      try {
        const response = await fetch('/profile/picture', {
          method: 'DELETE'
        });

        const result = await response.json();
        // console.log('Delete response:', result);

        if (result.success) {
          // console.log('âœ… Removal successful');
          showAlert('Profile picture removed successfully!', 'success');

          // Update all profile pictures to default
          const defaultImage = '/images/default-avatar.png?t=' + Date.now();
          updateAllProfilePictures(defaultImage);

        } else {
          // console.error('âŒ Removal failed:', result.error);
          showAlert(result.error || 'Error removing picture', 'danger');
        }
      } catch (error) {
        // console.error('âŒ Delete error:', error);
        showAlert('Error removing profile picture: ' + error.message, 'danger');
      }
    }

    // Show Alert Function
    function showAlert(message, type) {
      // console.log('Showing alert:', type, message);

      // Remove existing alerts
      const existingAlerts = document.querySelectorAll('.alert');
      existingAlerts.forEach(alert => alert.remove());

      const alertDiv = document.createElement('div');
      alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
      alertDiv.innerHTML = `
        <i class="bi bi-${type === 'success' ? 'check-circle' : 'exclamation-triangle'} me-2"></i>
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

      const container = document.querySelector('.container-fluid');
      if (container) {
        container.insertBefore(alertDiv, container.firstChild);

        // Auto remove after 5 seconds
        setTimeout(() => {
          if (alertDiv.parentNode) {
            alertDiv.remove();
          }
        }, 5000);
      }
    }

    let currentZoom = 1;
    const ZOOM_STEP = 0.5;
    const MAX_ZOOM = 3;
    const MIN_ZOOM = 1;
    let initialDistance = null;
    let lastTouchEnd = 0;

    function setupImageZoom() {
      const modalImg = document.getElementById('modalProfilePicture');
      const modal = document.getElementById('profilePictureModal');
      const zoomInBtn = document.getElementById('zoomInBtn');
      const zoomOutBtn = document.getElementById('zoomOutBtn');
      const resetZoomBtn = document.getElementById('resetZoomBtn');

      if (!modalImg || !modal) return;

      // Click to toggle zoom (double tap on mobile)
      let lastTap = 0;
      modalImg.addEventListener('click', function (e) {
        e.stopPropagation();

        // Handle double tap on mobile
        if (window.innerWidth <= 768) {
          const currentTime = new Date().getTime();
          const tapLength = currentTime - lastTap;

          if (tapLength < 300 && tapLength > 0) {
            // Double tap detected
            if (currentZoom > 1) {
              resetZoom();
            } else {
              zoomIn();
            }
            lastTap = 0;
            return;
          }
          lastTap = currentTime;
        }
        // Single click/tape on desktop
        toggleZoom();
      });

      // Pinch to zoom for mobile
      modalImg.addEventListener('touchstart', function (e) {
        if (e.touches.length === 2) {
          e.preventDefault();
          initialDistance = Math.hypot(
            e.touches[0].clientX - e.touches[1].clientX,
            e.touches[0].clientY - e.touches[1].clientY
          );
        }
      });

      modalImg.addEventListener('touchmove', function (e) {
        if (e.touches.length === 2 && initialDistance) {
          e.preventDefault();

          const currentDistance = Math.hypot(
            e.touches[0].clientX - e.touches[1].clientX,
            e.touches[0].clientY - e.touches[1].clientY
          );

          // Calculate zoom factor
          const zoomFactor = currentDistance / initialDistance;

          // Apply pinch zoom
          if (zoomFactor > 1.1) {
            // Pinching out (zoom in)
            if (currentZoom < MAX_ZOOM) {
              currentZoom = Math.min(currentZoom + 0.1, MAX_ZOOM);
              applyZoom();
              initialDistance = currentDistance;
            }
          } else if (zoomFactor < 0.9) {
            // Pinching in (zoom out)
            if (currentZoom > MIN_ZOOM) {
              currentZoom = Math.max(currentZoom - 0.1, MIN_ZOOM);
              applyZoom();
              initialDistance = currentDistance;
            }
          }
        }
      });

      modalImg.addEventListener('touchend', function (e) {
        if (e.touches.length < 2) {
          initialDistance = null;
        }
      });

      // Zoom in button
      if (zoomInBtn) {
        zoomInBtn.addEventListener('click', function (e) {
          e.stopPropagation();
          zoomIn();
        });
      }

      // Zoom out button
      if (zoomOutBtn) {
        zoomOutBtn.addEventListener('click', function (e) {
          e.stopPropagation();
          zoomOut();
        });
      }

      // Reset zoom button
      if (resetZoomBtn) {
        resetZoomBtn.addEventListener('click', function (e) {
          e.stopPropagation();
          resetZoom();
        });
      }

      // Reset zoom when modal is hidden
      modal.addEventListener('hidden.bs.modal', function () {
        resetZoom();
        currentZoom = 1;
        translateX = 0;
        translateY = 0;
        updateZoomButtons();
      });

      // Handle keyboard shortcuts (desktop only)
      document.addEventListener('keydown', function (e) {
        if (!modal.classList.contains('show')) return;

        // Don't handle keyboard shortcuts on mobile
        if (window.innerWidth <= 768) return;

        switch (e.key) {
          case '+':
          case '=':
            if (e.ctrlKey || e.metaKey) {
              e.preventDefault();
              zoomIn();
            }
            break;
          case '-':
            if (e.ctrlKey || e.metaKey) {
              e.preventDefault();
              zoomOut();
            }
            break;
          case '0':
            if (e.ctrlKey || e.metaKey) {
              e.preventDefault();
              resetZoom();
            }
            break;
          case 'Escape':
            if (modalImg.classList.contains('zoomed')) {
              e.preventDefault();
              resetZoom();
            }
            break;
        }
      });

      // Handle wheel zoom (desktop only)
      modalImg.addEventListener('wheel', function (e) {
        // Don't handle wheel on mobile
        if (window.innerWidth <= 768) return;

        if (e.ctrlKey) {
          e.preventDefault();
          if (e.deltaY < 0) {
            zoomIn();
          } else {
            zoomOut();
          }
        }
      });

      // Adding escape hatch for mobile - tap outside image to reset zoom
      modal.addEventListener('click', function (e) {
        if (window.innerWidth <= 768 && currentZoom > 1 && !modalImg.contains(e.target)) {
          resetZoom();
        }
      });
    }

    // Add mobile-specific zoom functions
    function isMobileDevice() {
      return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || window.innerWidth <= 768;
    }

    function zoomIn() {
      const modalImg = document.getElementById('modalProfilePicture');
      const modal = document.getElementById('profilePictureModal');

      if (!modalImg || !modal || currentZoom >= MAX_ZOOM) return;

      // Smaller steps on mobile
      const zoomStep = isMobileDevice() ? 0.25 : ZOOM_STEP;
      currentZoom = Math.min(currentZoom + zoomStep, MAX_ZOOM);
      applyZoom();
    }

    function zoomOut() {
      const modalImg = document.getElementById('modalProfilePicture');
      const modal = document.getElementById('profilePictureModal');

      if (!modalImg || !modal || currentZoom <= MIN_ZOOM) return;

      // Smaller steps on mobile
      const zoomStep = isMobileDevice() ? 0.25 : ZOOM_STEP;
      currentZoom = Math.max(currentZoom - zoomStep, MIN_ZOOM);
      applyZoom();
    }

    function resetZoom() {
      const modalImg = document.getElementById('modalProfilePicture');
      const modal = document.getElementById('profilePictureModal');

      if (!modalImg || !modal) return;

      currentZoom = 1;
      translateX = 0;
      translateY = 0;
      applyZoom();

      // Show reset feedback on mobile
      if (isMobileDevice()) {
        showToast('Zoom reset to normal', 2000);
      }
    }

    // Add this helper function
    function showToast(message, duration) {
      // Remove existing toast
      const existingToast = document.getElementById('zoomToast');
      if (existingToast) {
        existingToast.remove();
      }

      const toast = document.createElement('div');
      toast.id = 'zoomToast';
      toast.innerHTML = `
        <div style="
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            z-index: 9999;
            font-size: 14px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            white-space: nowrap;
        ">
            ${message}
        </div>
    `;

      document.body.appendChild(toast);

      setTimeout(() => {
        if (toast.parentNode) {
          toast.remove();
        }
      }, duration);
    }

    // Update the applyZoom function for mobile
    function applyZoom() {
      const modalImg = document.getElementById('modalProfilePicture');
      const modal = document.getElementById('profilePictureModal');
      const zoomInBtn = document.getElementById('zoomInBtn');
      const zoomOutBtn = document.getElementById('zoomOutBtn');
      const resetZoomBtn = document.getElementById('resetZoomBtn');

      if (!modalImg || !modal) return;

      // Apply zoom transform
      modalImg.style.transform = `scale(${currentZoom}) translate(${translateX}px, ${translateY}px)`;

      // Toggle zoomed class
      if (currentZoom > 1) {
        modalImg.classList.add('zoomed');
        modal.classList.add('zoomed');
        document.body.classList.add('zoom-mode');

        // Enable panning when zoomed
        enableImagePanning();

        // Set grab cursor on desktop
        if (!isMobileDevice()) {
          modalImg.style.cursor = 'grab';
        }
      } else {
        modalImg.classList.remove('zoomed');
        modal.classList.remove('zoomed');
        document.body.classList.remove('zoom-mode');

        // Reset pan position
        modalImg.style.transform = `scale(1) translate(0px, 0px)`;
        disableImagePanning();

        // Set regular pointer cursor (not zoom-in)
        modalImg.style.cursor = 'pointer';
      }

      // Update button states
      updateZoomButtons();
    }

    // Update touch event handling for mobile panning
    function enableImagePanning() {
      const modalImg = document.getElementById('modalProfilePicture');
      if (!modalImg) return;

      modalImg.addEventListener('mousedown', startPan);
      modalImg.addEventListener('touchstart', startPanTouch);
      document.addEventListener('mousemove', pan);
      document.addEventListener('touchmove', panTouch);
      document.addEventListener('mouseup', stopPan);
      document.addEventListener('touchend', stopPan);
      document.addEventListener('touchcancel', stopPan);
    }

    function startPanTouch(e) {
      if (!document.getElementById('modalProfilePicture').classList.contains('zoomed')) return;

      // Only start panning with one finger
      if (e.touches.length !== 1) return;

      isPanning = true;
      const touch = e.touches[0];
      startX = touch.clientX - translateX;
      startY = touch.clientY - translateY;
      e.preventDefault();
    }

    function panTouch(e) {
      if (!isPanning) return;

      // Only pan with one finger
      if (e.touches.length !== 1) return;

      const touch = e.touches[0];
      translateX = touch.clientX - startX;
      translateY = touch.clientY - startY;

      const modalImg = document.getElementById('modalProfilePicture');
      modalImg.style.transform = `scale(${currentZoom}) translate(${translateX}px, ${translateY}px)`;

      e.preventDefault();
    }

    // Add emergency reset button for mobile
    function addMobileResetButton() {
      const modal = document.getElementById('profilePictureModal');
      if (!modal || !isMobileDevice()) return;

      // Remove existing reset button if any
      const existingReset = document.getElementById('mobileResetZoom');
      if (existingReset) existingReset.remove();

      const resetBtn = document.createElement('button');
      resetBtn.id = 'mobileResetZoom';
      resetBtn.innerHTML = `
        <i class="bi bi-arrow-counterclockwise"></i>
        <span>Reset Zoom</span>
    `;
      resetBtn.style.cssText = `
        position: fixed;
        top: 70px;
        right: 15px;
        background: rgba(0, 0, 0, 0.8);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 25px;
        padding: 10px 15px;
        z-index: 1060;
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
        backdrop-filter: blur(10px);
        cursor: pointer;
    `;

      resetBtn.addEventListener('click', function (e) {
        e.stopPropagation();
        resetZoom();
      });

      modal.appendChild(resetBtn);

      // Show/hide based on zoom level
      const observer = new MutationObserver(function () {
        const modalImg = document.getElementById('modalProfilePicture');
        if (modalImg && modalImg.classList.contains('zoomed')) {
          resetBtn.style.display = 'flex';
        } else {
          resetBtn.style.display = 'none';
        }
      });

      observer.observe(document.getElementById('modalProfilePicture'), {
        attributes: true,
        attributeFilter: ['class']
      });
    }

    // Call this in viewProfilePicture function
    function viewProfilePicture() {
      hideProfilePictureMenu();

      const profilePicture = document.getElementById('profilePicture');
      const modalProfilePicture = document.getElementById('modalProfilePicture');
      const modalElement = document.getElementById('profilePictureModal');

      if (!profilePicture || !modalProfilePicture || !modalElement) return;

      // Reset zoom state
      currentZoom = 1;
      translateX = 0;
      translateY = 0;

      // Get the Bootstrap modal instance
      const modal = bootstrap.Modal.getInstance(modalElement) || new bootstrap.Modal(modalElement);
      const pictureUrl = profilePicture.src;

      // Set the image source with cache busting
      modalProfilePicture.src = pictureUrl + (pictureUrl.includes('?') ? '&' : '?') + 't=' + Date.now();

      // Reset image transform
      modalProfilePicture.style.transform = 'scale(1) translate(0px, 0px)';
      modalProfilePicture.classList.remove('zoomed');
      modalElement.classList.remove('zoomed');

      modal.show();

      // Update zoom buttons
      updateZoomButtons();

      // Add mobile reset button
      setTimeout(() => {
        addMobileResetButton();
      }, 100);
    }
































    function toggleZoom() {
      const modalImg = document.getElementById('modalProfilePicture');
      const modal = document.getElementById('profilePictureModal');

      if (!modalImg || !modal) return;

      if (modalImg.classList.contains('zoomed')) {
        resetZoom();
      } else {
        zoomIn();
      }
    }







    function updateZoomButtons() {
      const zoomInBtn = document.getElementById('zoomInBtn');
      const zoomOutBtn = document.getElementById('zoomOutBtn');
      const resetZoomBtn = document.getElementById('resetZoomBtn');

      if (zoomInBtn) {
        zoomInBtn.disabled = currentZoom >= MAX_ZOOM;
        zoomInBtn.title = currentZoom >= MAX_ZOOM ? 'Maximum zoom reached' : 'Zoom In (Ctrl + +)';
      }

      if (zoomOutBtn) {
        zoomOutBtn.disabled = currentZoom <= MIN_ZOOM;
        zoomOutBtn.title = currentZoom <= MIN_ZOOM ? 'Minimum zoom reached' : 'Zoom Out (Ctrl + -)';
      }

      if (resetZoomBtn) {
        resetZoomBtn.disabled = currentZoom === MIN_ZOOM;
        resetZoomBtn.title = currentZoom === MIN_ZOOM ? 'Already at normal size' : 'Reset Zoom (Ctrl + 0)';
      }
    }

    // Image panning functionality for when zoomed
    let isPanning = false;
    let startX, startY;
    let translateX = 0, translateY = 0;



    function disableImagePanning() {
      const modalImg = document.getElementById('modalProfilePicture');
      if (!modalImg) return;

      modalImg.removeEventListener('mousedown', startPan);
      modalImg.removeEventListener('touchstart', startPanTouch);
      document.removeEventListener('mousemove', pan);
      document.removeEventListener('touchmove', panTouch);
      document.removeEventListener('mouseup', stopPan);
      document.removeEventListener('touchend', stopPan);
      document.removeEventListener('touchcancel', stopPan);

      translateX = 0;
      translateY = 0;
    }

    function startPan(e) {
      if (!document.getElementById('modalProfilePicture').classList.contains('zoomed')) return;

      isPanning = true;
      startX = e.clientX - translateX;
      startY = e.clientY - translateY;
      document.getElementById('modalProfilePicture').style.cursor = 'grabbing';
      e.preventDefault();
    }



    function pan(e) {
      if (!isPanning) return;

      translateX = e.clientX - startX;
      translateY = e.clientY - startY;

      const modalImg = document.getElementById('modalProfilePicture');
      modalImg.style.transform = `scale(${currentZoom}) translate(${translateX}px, ${translateY}px)`;
    }



    function stopPan() {
      isPanning = false;
      const modalImg = document.getElementById('modalProfilePicture');
      if (modalImg) {
        modalImg.style.cursor = 'grab';
      }
    }



    // Update Header Profile Picture Function
    function updateHeaderProfilePicture(url) {
      // console.log('Updating header images with:', url);
      const headerImages = document.querySelectorAll('.navbar img, .user-avatar-modern');
      headerImages.forEach(img => {
        if (img.src && typeof img.src === 'string' &&
          (img.src.includes('profile') ||
            (img.alt && img.alt.includes('Profile')) ||
            img.classList.contains('user-avatar-modern'))) {
          img.src = url + '?t=' + Date.now();
        }
      });
    }



    // Update Header Username Function
    function updateHeaderUsername(newUsername) {
      const desktopUsername = document.querySelector('.header-icons.d-none.d-lg-flex .username-modern');
      if (desktopUsername) {
        desktopUsername.textContent = newUsername;
      }

      document.title = document.title.replace(/<%= user.username %>/g, newUsername);
    }

    // Profile Picture Action Menu Functions
    function toggleProfilePictureMenu(e) {
      e.stopPropagation(); // Prevent event bubbling

      const menu = document.getElementById('profilePictureMenu');
      const profilePic = document.getElementById('profilePicture');

      if (menu.classList.contains('show')) {
        hideProfilePictureMenu();
        return;
      }

      // Show the menu
      menu.classList.add('show');

      // Add click outside listener
      setTimeout(() => {
        document.addEventListener('click', hideProfilePictureMenuOnClickOutside);
      }, 10);
    }

    function hideProfilePictureMenu() {
      const menu = document.getElementById('profilePictureMenu');
      menu.classList.remove('show');
      document.removeEventListener('click', hideProfilePictureMenuOnClickOutside);
    }

    function hideProfilePictureMenuOnClickOutside(e) {
      const menu = document.getElementById('profilePictureMenu');
      const profilePic = document.getElementById('profilePicture');

      if (!menu.contains(e.target) && !profilePic.contains(e.target)) {
        hideProfilePictureMenu();
      }
    }


    function openFileInput() {
      hideProfilePictureMenu();
      document.getElementById('profilePictureInput').click();
    }

    // Update the setupProfilePictureViewer function to use the new menu
    function setupProfilePictureViewer() {
      const profilePicture = document.getElementById('profilePicture');
      const modalElement = document.getElementById('profilePictureModal');

      if (!profilePicture || !modalElement) return;

      // Change from direct modal opening to menu opening
      profilePicture.addEventListener('click', toggleProfilePictureMenu);

      // Keep the modal initialization for when viewProfilePicture is called
      const modal = new bootstrap.Modal(modalElement, {
        backdrop: true,
        keyboard: true,
        focus: true
      });

      const modalProfilePicture = document.getElementById('modalProfilePicture');

      // Make the modal image clickable to close
      if (modalProfilePicture) {
        modalProfilePicture.addEventListener('click', function (e) {
          e.stopPropagation();
          modal.hide();
        });
      }

      // Close modal when clicking outside the image
      modalElement.addEventListener('click', function (e) {
        if (e.target === this || e.target.classList.contains('modal-content')) {
          modal.hide();
        }
      });

      // Handle escape key
      document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape' && modalElement.classList.contains('show')) {
          modal.hide();
        }
      });
    }


    // Form Handlers
    async function handleUsernameUpdate(e) {
      e.preventDefault();

      const usernameInput = document.getElementById('usernameInput');
      const updateUsernameBtn = document.getElementById('updateUsernameBtn');
      const newUsername = usernameInput.value.trim();

      if (newUsername.length < 3) {
        showAlert('Username must be at least 3 characters long', 'danger');
        return;
      }

      if (newUsername === '<%= user.username %>') {
        showAlert('Please enter a different username', 'info');
        return;
      }

      updateUsernameBtn.disabled = true;
      updateUsernameBtn.innerHTML = '<i class="bi bi-arrow-repeat spinner-border spinner-border-sm"></i>';

      try {
        const response = await fetch('/profile/username', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ username: newUsername })
        });

        const result = await response.json();

        if (result.success) {
          showAlert('Username updated successfully!', 'success');
          document.querySelector('h3.h5').textContent = newUsername;
          updateHeaderUsername(newUsername);
        } else {
          showAlert(result.error || 'Error updating username', 'danger');
          usernameInput.value = '<%= user.username %>';
        }
      } catch (error) {
        // console.error('Username update error:', error);
        showAlert('Error updating username: ' + error.message, 'danger');
        usernameInput.value = '<%= user.username %>';
      } finally {
        updateUsernameBtn.disabled = false;
        updateUsernameBtn.innerHTML = '<i class="bi bi-check-lg"></i>';
      }
    }

    async function handleEmailUpdate(e) {
      e.preventDefault();

      const emailInput = document.getElementById('emailInput');
      const updateEmailBtn = document.getElementById('updateEmailBtn');
      const newEmail = emailInput.value.trim();

      if (!newEmail) {
        showAlert('Please enter an email address', 'danger');
        return;
      }

      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(newEmail)) {
        showAlert('Please enter a valid email address', 'danger');
        return;
      }

      if (newEmail === '<%= user.email %>') {
        showAlert('Please enter a different email address', 'info');
        return;
      }

      updateEmailBtn.disabled = true;
      updateEmailBtn.innerHTML = '<i class="bi bi-arrow-repeat spinner-border spinner-border-sm"></i> Updating...';

      try {
        const response = await fetch('/profile/email', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ email: newEmail })
        });

        const result = await response.json();

        if (result.success) {
          showAlert(result.message, 'success');
          emailInput.value = '';
          setTimeout(() => {
            checkPendingEmailStatus();
          }, 1000);

        } else {
          showAlert(result.error || 'Error updating email', 'danger');
        }
      } catch (error) {
        // console.error('Email update error:', error);
        showAlert('Error updating email: ' + error.message, 'danger');
      } finally {
        updateEmailBtn.disabled = false;
        updateEmailBtn.innerHTML = 'Update Email';
      }
    }

    async function handleBioUpdate(e) {
      e.preventDefault();

      const bioInput = document.getElementById('bioInput');
      const updateBioBtn = document.getElementById('updateBioBtn');
      const newBio = bioInput.value.trim();
      const originalBio = '<%= user.bio || "" %>';

      if (newBio.length > 500) {
        showAlert('Bio must be less than 500 characters', 'danger');
        return;
      }

      if (newBio === originalBio) {
        showAlert('Please make changes to update your bio', 'info');
        return;
      }

      updateBioBtn.disabled = true;
      updateBioBtn.innerHTML = '<i class="bi bi-arrow-repeat spinner-border spinner-border-sm me-2"></i>Updating...';

      try {
        const response = await fetch('/profile/bio', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ bio: newBio })
        });

        const result = await response.json();

        if (result.success) {
          showAlert(result.message, 'success');
          document.getElementById('cancelBioBtn').style.display = 'none';
          setTimeout(() => location.reload(), 1500);
        } else {
          showAlert(result.error || 'Error updating bio', 'danger');
        }
      } catch (error) {
        // console.error('Bio update error:', error);
        showAlert('Error updating bio: ' + error.message, 'danger');
      } finally {
        updateBioBtn.disabled = false;
        updateBioBtn.innerHTML = '<i class="bi bi-check-lg me-2"></i>Update Bio';
      }
    }

    // Email Status Functions
    async function checkPendingEmailStatus() {
      try {
        const response = await fetch('/profile/email/pending');
        const result = await response.json();

        if (result.success && result.hasPendingEmail) {
          const container = document.getElementById('pendingEmailContainer');
          const emailText = document.getElementById('pendingEmailText');

          container.style.display = 'block';
          emailText.textContent = result.pendingEmail;

          showAlert(`Email change pending: ${result.pendingEmail}. Check your email to verify.`, 'warning');
        }
      } catch (error) {
        // console.error('Error checking pending email:', error);
      }
    }

    async function cancelPendingEmail() {
      if (!confirm('Are you sure you want to cancel the pending email change?')) {
        return;
      }

      try {
        const response = await fetch('/profile/email/cancel', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          }
        });

        const result = await response.json();

        if (result.success) {
          showAlert('Pending email change cancelled successfully', 'success');
          location.reload();
        } else {
          showAlert(result.error || 'Error cancelling pending email', 'danger');
        }
      } catch (error) {
        // console.error('Cancel pending email error:', error);
        showAlert('Error cancelling pending email: ' + error.message, 'danger');
      }
    }

    async function resendVerification() {
      try {
        showAlert('Sending verification email...', 'info');

        const response = await fetch('/auth/resend-verification', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          }
        });

        const result = await response.json();

        if (result.success) {
          showAlert('Verification email sent successfully! Please check your inbox.', 'success');
        } else {
          showAlert(result.error || 'Error sending verification email', 'danger');
        }
      } catch (error) {
        // console.error('Resend verification error:', error);
        showAlert('Error sending verification email: ' + error.message, 'danger');
      }
    }





    document.addEventListener('DOMContentLoaded', function () {
      // Initialize pending email status
      checkPendingEmailStatus();

      // Initialize profile picture viewer
      setupProfilePictureViewer();

      fixModalAccessibility();

      // Initialize zoom functionality - CALL THIS AFTER setupProfilePictureViewer
      setTimeout(() => {
        setupImageZoom();
      }, 100);

      // Add mobile-specific features
      if (window.innerWidth <= 768) {
        // Add viewport meta tag for better mobile experience
        const metaViewport = document.createElement('meta');
        metaViewport.name = 'viewport';
        metaViewport.content = 'width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes';
        document.head.appendChild(metaViewport);
      }
      // Bio character count
      const bioInput = document.getElementById('bioInput');
      const bioCharCount = document.getElementById('bioCharCount');

      if (bioInput && bioCharCount) {
        bioCharCount.textContent = bioInput.value.length;
        bioInput.addEventListener('input', function () {
          bioCharCount.textContent = this.value.length;
        });
      }

      // File input handling
      const fileInput = document.getElementById('profilePictureInput');
      const cameraLabel = document.querySelector('label[for="profilePictureInput"]');

      if (cameraLabel) {
        cameraLabel.addEventListener('click', function (e) {
          e.preventDefault();
          if (fileInput && !isUploading) {
            fileInput.click();
          }
        });
      }

      if (fileInput) {
        fileInput.addEventListener('change', function (e) {
          if (this.files && this.files[0] && !isUploading) {
            uploadProfilePicture(this.files[0]);
          }
        });
      }

      // Form submissions
      const usernameForm = document.getElementById('usernameForm');
      if (usernameForm) {
        usernameForm.addEventListener('submit', handleUsernameUpdate);
      }

      const emailForm = document.getElementById('emailForm');
      if (emailForm) {
        emailForm.addEventListener('submit', handleEmailUpdate);
      }

      const bioForm = document.getElementById('bioForm');
      if (bioForm) {
        bioForm.addEventListener('submit', handleBioUpdate);
      }

      // Bio cancel button
      const bioInputField = document.getElementById('bioInput');
      const cancelBioBtn = document.getElementById('cancelBioBtn');
      const originalBio = '<%= user.bio || "" %>';

      if (bioInputField && cancelBioBtn) {
        bioInputField.addEventListener('input', function () {
          const hasChanges = this.value !== originalBio;
          cancelBioBtn.style.display = hasChanges ? 'block' : 'none';
        });

        cancelBioBtn.addEventListener('click', function () {
          bioInputField.value = originalBio;
          this.style.display = 'none';
        });
      }
    });






// Email verification status check
<% if (!user.is_verified) { %>
      setInterval(async () => {
        try {
          const response = await fetch('/profile/email/status');
          const result = await response.json();

          if (result.success && result.isVerified) {
            showAlert('Email verified successfully!', 'success');
            setTimeout(() => location.reload(), 2000);
          }
        } catch (error) {
          // console.error('Email status check error:', error);
        }
      }, 30000);
<% } %>

      // Global Error Handler
      window.addEventListener('error', function (e) {
        // console.error('Global error:', e.error);
        showAlert('An error occurred: ' + e.error.message, 'danger');
      });
  </script>

  <%- include('partials/footer') %>